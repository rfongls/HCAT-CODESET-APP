<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Codeset Automation App</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
</head>
<body>
    <header>
        <h1>Codeset Automation App</h1>
    </header>
    {% if error %}
    <div class="error">{{ error }}</div>
    {% endif %}
    <form method="post" enctype="multipart/form-data">
        <input type="file" name="workbook" accept=".xlsx" />
        <button type="submit">Upload</button>
    </form>

    {% if sheet_names %}
    <div class="tabs">
        <div class="sheet-selector">
            <select id="sheet-select">
            {% for sheet in sheet_names %}
                <option value="{{ sheet }}" {% if sheet == initial_sheet %}selected{% endif %}>{{ sheet }}</option>
            {% endfor %}
            </select>
        </div>
        <div id="table-wrapper"></div>
    </div>
    {% endif %}

    <script>
    const mappings = {{ mappings|tojson }};
    const dropdowns = {{ dropdowns|tojson }};
    const headers = {{ headers|tojson }};
    const formulas = {{ formulas|tojson }};
    const sheetNames = {{ sheet_names|tojson }};
    const initialSheet = {{ initial_sheet|tojson }};
    const workbook = {};
    workbook[initialSheet] = {{ initial_records|tojson }};

    document.addEventListener('DOMContentLoaded', () => {
        const selector = document.getElementById('sheet-select');

        function createInput(sheet, header, value = '') {
            const key = header.toUpperCase().replace(' ', '_');
            const mapInfo = mappings[sheet] || {};
            const opts = dropdowns[sheet] && dropdowns[sheet][header];
            if (mapInfo.mapped_col && header === mapInfo.mapped_col && opts) {
                const sel = document.createElement('select');
                sel.className = 'mapped-select';
                sel.dataset.sheet = sheet;
                sel.dataset.col = header;
                const blank = document.createElement('option');
                blank.value = '';
                blank.textContent = '';
                if (!value) blank.selected = true;
                sel.appendChild(blank);
                opts.forEach(o => {
                    const option = document.createElement('option');
                    option.value = o;
                    option.textContent = o;
                    if (o === value) option.selected = true;
                    sel.appendChild(option);
                });
                return sel;
            }
            if (key === 'CODE' || key === 'DISPLAY_VALUE') {
                const input = document.createElement('input');
                input.type = 'text';
                input.value = value || '';
                return input;
            }
            if (mapInfo.sub_col && header === mapInfo.sub_col) {
                const input = document.createElement('input');
                input.type = 'text';
                input.readOnly = true;
                input.value = value || '';
                return input;
            }
            const span = document.createElement('span');
            span.textContent = value || '';
            return span;
        }

        function updateSubDefinition(sel) {
            const sheet = sel.dataset.sheet;
            const mapInfo = mappings[sheet];
            if (!mapInfo) return;
            const mapping = mapInfo.map;
            const subCol = mapInfo.sub_col;
            const row = sel.closest('tr');
            if (row && subCol) {
                const headerList = Array.from(
                    row.closest('table').querySelectorAll('th')
                ).map(th => th.innerText);
                const subIndex = headerList.indexOf(subCol);
                if (subIndex !== -1) {
                    const cell = row.children[subIndex];
                    if (cell) {
                        const input = cell.querySelector('input, select');
                        if (input) {
                            input.value = mapping[sel.value] || '';
                        } else {
                            cell.textContent = mapping[sel.value] || '';
                        }
                    }
                }
            }
        }

        function readSheet(table, sheet) {
            const rows = [];
            const headerList = headers[sheet];
            table.querySelectorAll('tbody tr').forEach(tr => {
                const obj = {};
                headerList.forEach((h, idx) => {
                    const cell = tr.children[idx];
                    const input = cell.querySelector('input, select');
                    obj[h] = input ? input.value : cell.textContent;
                });
                rows.push(obj);
            });
            return rows;
        }

        function syncCurrentSheet() {
            const sheet = selector.value;
            const table = document.querySelector('#table-wrapper table');
            if (!table) return;
            workbook[sheet] = readSheet(table, sheet);
        }

        function renderSheet(sheet) {
            const container = document.getElementById('table-wrapper');
            container.innerHTML = '';
            const table = document.createElement('table');
            table.className = 'codeset-table';
            table.id = 'table-' + sheet.replace(/[^a-zA-Z0-9_]/g, '_');
            const thead = document.createElement('thead');
            const headRow = document.createElement('tr');
            headers[sheet].forEach(h => {
                const th = document.createElement('th');
                th.textContent = h;
                headRow.appendChild(th);
            });
            thead.appendChild(headRow);
            table.appendChild(thead);
            const tbody = document.createElement('tbody');
            (workbook[sheet] || []).forEach(row => {
                const tr = document.createElement('tr');
                headers[sheet].forEach(h => {
                    const td = document.createElement('td');
                    const input = createInput(sheet, h, row[h]);
                    td.appendChild(input);
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            container.appendChild(table);

            const addBtn = document.createElement('button');
            addBtn.className = 'add-row';
            addBtn.textContent = 'Add Row';
            addBtn.addEventListener('click', () => {
                const tr = document.createElement('tr');
                headers[sheet].forEach(h => {
                    const td = document.createElement('td');
                    const input = createInput(sheet, h);
                    td.appendChild(input);
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            container.appendChild(addBtn);

            const saveBtn = document.createElement('button');
            saveBtn.id = 'export-workbook';
            saveBtn.textContent = 'Export Workbook';
            saveBtn.addEventListener('click', async () => {
                syncCurrentSheet();
                const resp = await fetch('/export', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(workbook)
                });
                if (resp.ok) {
                    const blob = await resp.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const disposition = resp.headers.get('Content-Disposition');
                    let fname = 'updated_workbook.xlsx';
                    if (disposition) {
                        const match = disposition.match(/filename="?([^";]+)"?/);
                        if (match) fname = match[1];
                    }
                    a.download = fname;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    URL.revokeObjectURL(url);
                }
            });
            container.appendChild(saveBtn);

            if (formulas[sheet] && Object.keys(formulas[sheet]).length) {
                const h3 = document.createElement('h3');
                h3.textContent = 'Column Formulas';
                container.appendChild(h3);
                const ul = document.createElement('ul');
                Object.entries(formulas[sheet]).forEach(([col, formula]) => {
                    const li = document.createElement('li');
                    const strong = document.createElement('strong');
                    strong.textContent = col;
                    li.appendChild(strong);
                    li.appendChild(document.createTextNode(': ' + formula));
                    ul.appendChild(li);
                });
                container.appendChild(ul);
            }
        }

        async function ensureSheetLoaded(sheet) {
            if (workbook[sheet]) return;
            const resp = await fetch(`/sheet/${encodeURIComponent(sheet)}`);
            if (resp.ok) {
                workbook[sheet] = await resp.json();
            } else {
                workbook[sheet] = [];
            }
        }

        selector?.addEventListener('change', async () => {
            syncCurrentSheet();

            const sheet = selector.value;
            await ensureSheetLoaded(sheet);
            renderSheet(sheet);
        });

        (async () => {
            if (initialSheet) {
                await ensureSheetLoaded(initialSheet);
                renderSheet(initialSheet);
            }
        })();

        document.addEventListener('change', ev => {
            const target = ev.target;
            if (target.classList.contains('mapped-select')) {
                updateSubDefinition(target);
            }
        });
    });
    </script>
</body>
</html>
