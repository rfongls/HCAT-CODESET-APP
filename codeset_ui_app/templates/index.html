<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Codeset Management System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap CSS (base styles only) -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
    crossorigin="anonymous"
  />
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />

  <!-- Minimal extras for hamburger, menu, and overlay -->
  <style>
    header { position: relative; }
    .header-menu { position: absolute; top: 12px; right: 16px; }

    .hamburger-btn {
      width: 40px; height: 40px;
      display: inline-flex; align-items: center; justify-content: center;
      border-radius: .375rem; font-size: 1.25rem; line-height: 1;
      background: #fff; border: 1px solid rgba(0,0,0,.15);
      box-shadow: 0 1px 2px rgba(0,0,0,.06);
    }
    .hamburger-btn:hover { background: #f8f9fa; }

    .menu-pop {
      position: absolute; right: 16px; top: 56px;
      background: #fff; border: 1px solid rgba(0,0,0,.15); border-radius: .5rem;
      min-width: 160px; padding: .25rem; box-shadow: 0 10px 25px rgba(0,0,0,.15);
      z-index: 1060;
    }
    .menu-item {
      display: block; width: 100%; padding: .5rem .75rem; text-align: left;
      border: 0; background: transparent; border-radius: .375rem;
    }
    .menu-item:hover { background: #f2f2f7; }

    .overlay { position: fixed; inset: 0; display: none; z-index: 1050; }
    .overlay.open { display: block; }
    .overlay-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,.45); }
    .overlay-dialog {
      position: relative; margin: 4vh auto; width: min(1200px, 95vw); max-height: 92vh;
      display: flex; flex-direction: column; background: var(--background-color); border-radius: .75rem;
      box-shadow: 0 20px 60px rgba(0,0,0,.25); overflow: hidden;
    }
    .overlay-header {
      padding: .75rem 1rem; background: var(--primary-color); color: #fff;
      display: flex; align-items: center; justify-content: space-between;
    }
    .overlay-body { padding: 1rem; overflow: auto; }
    .no-scroll { overflow: hidden; }

    .section-title { font-weight: 700; margin-bottom: .5rem; }
  </style>
</head>
<body>
  <header>
    <h1>Codeset Management System</h1>
    <div class="header-menu">
      <button id="hamburger" class="hamburger-btn" type="button" aria-haspopup="true" aria-expanded="false" aria-controls="headerMenu" aria-label="Open menu">☰</button>
      <div id="headerMenu" class="menu-pop d-none" role="menu" aria-hidden="true">
        {% if selected_workbook %}
        <button id="menuOpenControls" class="menu-item" role="menuitem" type="button">Controls</button>
        {% endif %}
        <button id="menuOpenTheme" class="menu-item" role="menuitem" type="button">Theme</button>
      </div>
    </div>
  </header>

  <main class="container-fluid my-4">
    {% if error %}
    <div class="alert alert-danger" role="alert">{{ error }}</div>
    {% endif %}

    {% if not selected_workbook %}
    <!-- LANDING CONTROLS (inline as before) -->
    <section id="inline-controls" class="mb-3">
      <div class="section-card">
        <form id="path-form-inline" method="post" class="row g-2 align-items-end mb-3">
          <div class="col-12 col-md-8">
            <label class="form-label"><b>Select repository folder</b></label>
            <div class="input-group">
              <input type="text" name="repo_base" class="form-control selected-primary js-repo-base"
                     value="{{ repo_base or '' }}" placeholder="Enter folder path" />
              <button type="button" class="btn btn-outline-secondary js-repo-browse">Browse…</button>
            </div>
          </div>
          <div class="col-12 col-md-2">
            <button type="submit" name="save_repo_base" value="1"
                    class="btn btn-outline-secondary w-100 js-repo-save" disabled>Save</button>
          </div>
          <div class="col-12 col-md-2">
            <button type="submit" class="btn btn-primary w-100 js-repo-load" disabled>Load</button>
          </div>
        </form>

        <form id="repo-form-inline" method="post" class="row g-2 align-items-end">
          <div class="col-12 col-md-4">
            <label class="form-label"><b>Select the repository you want to edit a codeset for:</b></label>
            <!-- Yellow by default on landing -->
            <select name="repo"
                    class="form-select selected-primary js-repo-select {% if selected_repo %}selected-primary{% endif %}"
                    {% if not repositories %}disabled{% endif %}>
              <option value="">{% if repositories %}Select repository{% else %}Load a repository folder first{% endif %}</option>
              {% for repo in repositories or [] %}
              <option value="{{ repo }}" {% if repo == selected_repo %}selected{% endif %}>{{ repo }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-12 col-md-4">
            <label class="form-label"><b>Workbook</b></label>
            <!-- Yellow by default on landing -->
            <select name="workbook_name"
                    class="form-select selected-primary js-workbook-select {% if selected_workbook %}selected-primary{% endif %}"
                    {% if not repo_files %}disabled{% endif %}>
              <option value="">Select workbook</option>
              {% for wb in repo_files or [] %}
              <option value="{{ wb }}" {% if wb == selected_workbook %}selected{% endif %}>{{ wb }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-12 col-md-2">
            <button type="submit" class="btn btn-primary w-100 js-load-btn" disabled>Load Workbook</button>
          </div>
          {% if sheet_names and not compare_mode %}
          <div class="col-12 col-md-2">
            <button type="submit" name="start_compare" value="1" class="btn btn-outline-primary w-100">Compare</button>
          </div>
          {% endif %}
        </form>

        {% if sheet_names and compare_mode %}
        <form id="compare-form-inline" method="post" class="row g-2 align-items-end mt-2">
          <div class="col-12 col-md-4">
            <select name="compare_repo" class="form-select js-compare-repo {% if comparison_active %}selected-compare{% endif %}">
              <option value="">Select repository</option>
              {% for repo in (comparison_repositories or repositories or []) %}
              <option value="{{ repo }}" {% if repo == selected_compare_repo %}selected{% endif %}>{{ repo }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-12 col-md-4">
            <select name="compare_workbook_name"
                    class="form-select js-compare-wb {% if comparison_active %}selected-compare{% endif %}"
                    {% if not compare_repo_files %}disabled{% endif %}>
              <option value="">Select workbook</option>
              {% for wb in compare_repo_files or [] %}
              <option value="{{ wb }}" {% if wb == selected_compare_workbook %}selected{% endif %}>{{ wb }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-12 col-md-2">
            {% if comparison_active %}
            <button type="submit" name="end_compare" value="1" class="btn btn-outline-secondary w-100">Clear Comparison</button>
            {% else %}
            <button type="submit" class="btn btn-outline-primary w-100">Load Comparison</button>
            {% endif %}
          </div>
        </form>
        {% endif %}

        <form id="upload-form-inline" method="post" enctype="multipart/form-data" class="row g-2 align-items-end mt-2">
          <div class="col-12 col-md-8">
            <input type="file" name="workbook" accept=".xlsx" class="form-control" />
          </div>
          <div class="col-12 col-md-2">
            <button type="submit" class="btn btn-secondary w-100">Upload</button>
          </div>
        </form>
      </div>
    </section>
    {% endif %}

    {% if sheet_names %}
    <hr class="section-divider" aria-hidden="true">

    <div class="section-card" id="active-sheet-card">
      <div class="section-title">Active Sheet</div>

      <div class="row g-2 align-items-end mb-3">
        <div class="col-12 col-md-8">
          <label for="sheet-select" class="form-label mb-0"><b>Sheet</b></label>
          <select id="sheet-select" class="form-select">
            {% for sheet in sheet_names %}
            <option value="{{ sheet }}" {% if sheet == initial_sheet %}selected{% endif %}>{{ sheet }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="d-none d-md-block col-md-2"></div>
        <div class="d-none d-md-block col-md-2"></div>
      </div>

      <div class="row">
        <div class="col-lg-9">
          <div id="table-wrapper" class="table-wrapper"></div>
          <div id="table-buttons" class="mt-2 d-flex gap-2"></div>
        </div>
        <div class="col-lg-3">
          <div id="fields-box" class="alert{% if not field_notes.get(initial_sheet) %} d-none{% endif %}">
            <h5 class="alert-heading fw-bold">Fields</h5>
            <p id="fields-text" class="mb-0">{{ field_notes.get(initial_sheet, '') }}</p>
          </div>
          <div id="requirements-box" class="alert alert-info">
            <h5 class="alert-heading fw-bold">Requirements</h5>
            <ul class="mb-0">
              <li>If CODE is populated, DISPLAY VALUE must be populated and vice versa.</li>
              <li>If STANDARD_CODE/STANDARD_DESCRIPTION exist, a MAPPED_STD_DESCRIPTION must be selected.</li>
              <li>If MAPPED_STD_DESCRIPTION is populated, CODE and DISPLAY VALUE must be provided.</li>
              <li>Codes must be unique within a tab.</li>
            </ul>
          </div>
          <div id="errors-box" class="alert alert-danger mt-3 d-none" aria-live="polite" aria-atomic="true">
            <h5 class="alert-heading fw-bold">Errors</h5>
            <ul id="error-list" class="mb-0"></ul>
            <button id="export-errors" class="btn btn-outline-danger btn-sm mt-2 d-none">Download Error Report</button>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
  </main>

  <!-- CONTROLS OVERLAY (for use AFTER workbook is loaded) -->
  <div id="controlsOverlay" class="overlay" aria-hidden="true">
    <div class="overlay-backdrop"></div>
    <div class="overlay-dialog" role="dialog" aria-modal="true" aria-labelledby="controlsOverlayTitle" tabindex="-1">
      <div class="overlay-header">
        <h5 id="controlsOverlayTitle" class="mb-0">Controls</h5>
        <button id="overlayClose" type="button" class="btn btn-danger btn-sm" aria-label="Close">&times;</button>
      </div>
      <div class="overlay-body">
        <div id="overlay-controls" class="section-card">
          <!-- Repository & Workbook card -->
          <div id="repo-workbook-card-modal" class="section-card">
            <div class="section-title">Repository &amp; Workbook</div>

            <!-- path -->
            <form id="path-form-modal" method="post" class="row g-2 align-items-end mb-3">
              <div class="col-12 col-md-8">
                <label class="form-label"><b>Select repository folder</b></label>
                <div class="input-group">
                  <input type="text" name="repo_base" class="form-control selected-primary js-repo-base"
                         value="{{ repo_base or '' }}" placeholder="Enter folder path" />
                  <button type="button" class="btn btn-outline-secondary js-repo-browse">Browse…</button>
                </div>
              </div>
              <div class="col-12 col-md-2">
                <button type="submit" name="save_repo_base" value="1"
                        class="btn btn-outline-secondary w-100 js-repo-save" disabled>Save</button>
              </div>
              <div class="col-12 col-md-2">
                <button type="submit" class="btn btn-primary w-100 js-repo-load" disabled>Load</button>
              </div>
            </form>

            <!-- repo/workbook -->
            <form id="repo-form-modal" method="post" class="row g-2 align-items-end">
              <div class="col-12 col-md-4">
                <label class="form-label"><b>Select the repository you want to edit a codeset for:</b></label>
                <select name="repo"
                        class="form-select selected-primary js-repo-select {% if selected_repo %}selected-primary{% endif %}"
                        {% if not repositories %}disabled{% endif %}
                        data-preselected="{{ selected_repo or '' }}">
                  <option value="">{% if repositories %}Select repository{% else %}Load a repository folder first{% endif %}</option>
                  {% for repo in repositories or [] %}
                  <option value="{{ repo }}" {% if repo == selected_repo %}selected{% endif %}>{{ repo }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label"><b>Workbook</b></label>
                <select name="workbook_name"
                        class="form-select selected-primary js-workbook-select {% if selected_workbook %}selected-primary{% endif %}"
                        {% if not repo_files %}disabled{% endif %}
                        data-preselected="{{ selected_workbook or '' }}">
                  <option value="">Select workbook</option>
                  {% for wb in repo_files or [] %}
                  <option value="{{ wb }}" {% if wb == selected_workbook %}selected{% endif %}>{{ wb }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-12 col-md-2">
                <button type="submit" class="btn btn-primary w-100 js-load-btn" disabled>Load Workbook</button>
              </div>

              {% if sheet_names %}
              <div class="col-12 col-md-2">
                <!-- Shows compare UI without submitting -->
                <button id="btn-show-compare-modal" type="button" class="btn btn-outline-primary w-100">Compare</button>
              </div>
              {% endif %}
            </form>
          </div>

          {% if sheet_names %}
          <!-- Comparison card -->
          <div id="compare-card-modal" class="section-card mt-3 {% if comparison_active %}{% else %}d-none{% endif %}">
            <div class="section-title">Comparison</div>
            <form id="compare-form-modal" method="post" class="row g-2 align-items-end">
              <div class="col-12 col-md-4">
                <select name="compare_repo" class="form-select js-compare-repo {% if comparison_active %}selected-compare{% endif %}">
                  <option value="">Select repository</option>
                  {% for repo in (comparison_repositories or repositories or []) %}
                  <option value="{{ repo }}" {% if repo == selected_compare_repo %}selected{% endif %}>{{ repo }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-12 col-md-4">
                <select name="compare_workbook_name"
                        class="form-select js-compare-wb {% if comparison_active %}selected-compare{% endif %}"
                        {% if not compare_repo_files %}disabled{% endif %}>
                  <option value="">Select workbook</option>
                  {% for wb in compare_repo_files or [] %}
                  <option value="{{ wb }}" {% if wb == selected_compare_workbook %}selected{% endif %}>{{ wb }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-12 col-md-2">
                {% if comparison_active %}
                <button type="submit" name="end_compare" value="1" class="btn btn-outline-secondary w-100">Clear Comparison</button>
                {% else %}
                <button type="submit" class="btn btn-outline-primary w-100">Load Comparison</button>
                {% endif %}
              </div>
            </form>
          </div>
          {% endif %}

          <!-- Upload (left outside cards or wrap if you prefer symmetry) -->
          <form id="upload-form-modal" method="post" enctype="multipart/form-data" class="row g-2 align-items-end mt-2">
            <div class="col-12 col-md-8">
              <input type="file" name="workbook" accept=".xlsx" class="form-control" />
            </div>
            <div class="col-12 col-md-2">
              <button type="submit" class="btn btn-secondary w-100">Upload</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- THEME OVERLAY -->
  <div id="themeOverlay" class="overlay" aria-hidden="true">
    <div class="overlay-backdrop"></div>
    <div class="overlay-dialog" role="dialog" aria-modal="true" aria-labelledby="themeOverlayTitle" tabindex="-1">
      <div class="overlay-header">
        <h5 id="themeOverlayTitle" class="mb-0">Theme</h5>
        <button id="themeOverlayClose" type="button" class="btn btn-danger btn-sm" aria-label="Close">&times;</button>
      </div>
      <div class="overlay-body">
        <div class="section-card">
          <div class="section-title">Theme Selection</div>
          <select id="theme-select" class="form-select">
            <option value="default">Default</option>
            <option value="blue">Blue</option>
            <option value="gray">Gray</option>
            <option value="dark">Dark</option>
            <option value="orange">Orange</option>
            <option value="pink">Pink</option>
            <option value="green">Green</option>
            <option value="lime">Lime</option>
            <option value="darkgray">Dark Gray</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-ZENmB1FQdJrEGAAtBqF7yqdv8cp8cYNjL6JTyAOuPBIYlFKE8ZFt5VtY3PQ9bFZV"
          crossorigin="anonymous"></script>

  <script>
    const themeSelect = document.getElementById('theme-select');
    const storedTheme = localStorage.getItem('theme') || 'default';
    document.documentElement.setAttribute('data-theme', storedTheme);
    if (themeSelect) {
      themeSelect.value = storedTheme;
      themeSelect.addEventListener('change', (e) => {
        const theme = e.target.value;
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
      });
    }

    const mappings = {{ mappings|tojson }};
    const dropdowns = {{ dropdowns|tojson }};
    const headers = {{ headers|tojson }};
    const renderHeaders = {{ render_headers|tojson }};
    const fieldNotes = {{ field_notes|tojson }};
    const sheetNames = {{ sheet_names|tojson }};
    const initialSheet = {{ initial_sheet|tojson }};
    const workbook = {};
    workbook[initialSheet] = {{ base_records|tojson }};
    const comparisonData = {};
    comparisonData[initialSheet] = {{ compare_records|tojson }};
    const originalFilename = {{ filename|tojson }};
    const hasSelectedWorkbook = {{ 'true' if selected_workbook else 'false' }};
    let sheetLock = false;
    let currentSheet = initialSheet;

    /* ---------- shared controls wiring (inline & overlay) ---------- */
    function wireControls(scope){
      if (!scope) return;

      const repoSelect = scope.querySelector('.js-repo-select');
      const workbookSelect = scope.querySelector('.js-workbook-select');
      const loadWorkbookBtn = scope.querySelector('.js-load-btn');
      const compareRepoSelect = scope.querySelector('.js-compare-repo');
      const compareWorkbookSelect = scope.querySelector('.js-compare-wb');

      const repoBase = scope.querySelector('.js-repo-base');
      const repoBrowse = scope.querySelector('.js-repo-browse');
      const repoLoad = scope.querySelector('.js-repo-load');
      const repoSave = scope.querySelector('.js-repo-save');

      function updateLoadEnable(){
        const hasRepo = !!(repoSelect && !repoSelect.disabled && repoSelect.value);
        const hasWb   = !!(workbookSelect && !workbookSelect.disabled && workbookSelect.value);
        if (loadWorkbookBtn) loadWorkbookBtn.disabled = !(hasRepo && hasWb);
      }
      function updateHighlights(){
        if (repoBase) repoBase.classList.toggle('selected-primary', true);
        if (repoSelect) repoSelect.classList.toggle('selected-primary', true); // keep yellow
        if (workbookSelect) workbookSelect.classList.toggle('selected-primary', true);
        if (compareRepoSelect) compareRepoSelect.classList.toggle('selected-compare', !!compareRepoSelect.value);
        if (compareWorkbookSelect) compareWorkbookSelect.classList.toggle('selected-compare', !!compareWorkbookSelect.value);
      }

      // Populate workbook list for a repo
      async function fillWorkbooksFor(repo) {
        if (!workbookSelect) return;
        workbookSelect.innerHTML = '<option value="">Select workbook</option>';
        if (!repo) { workbookSelect.disabled = true; updateLoadEnable(); return; }
        try {
          const resp = await fetch(`/workbooks/${encodeURIComponent(repo)}`);
          if (resp.ok) {
            const files = await resp.json();
            files.forEach(f => {
              const opt = document.createElement('option');
              opt.value = f; opt.textContent = f; workbookSelect.appendChild(opt);
            });
            workbookSelect.disabled = files.length === 0;
          } else {
            workbookSelect.disabled = true;
          }
        } catch {
          workbookSelect.disabled = true;
        }
        updateLoadEnable();
      }

      // If a repo is already selected on page load, prime without clearing a preselected workbook
      async function primeRepo(){
        updateHighlights();
        if (repoSelect && repoSelect.value) {
          // If the select already has a chosen workbook, don't refetch/clear
          const hasOptions = !!(workbookSelect && workbookSelect.options.length > 1);
          const hasChosen = hasOptions && Array.from(workbookSelect.options).some(o => o.selected && o.value);
          if (!hasOptions || !hasChosen) {
            await fillWorkbooksFor(repoSelect.value);
            const want = (workbookSelect && workbookSelect.dataset && workbookSelect.dataset.preselected) || '';
            if (want && workbookSelect) workbookSelect.value = want;
          }
        }
        updateLoadEnable();
      }

      repoSelect?.addEventListener('change', async () => {
        await fillWorkbooksFor(repoSelect.value);
        // Preserve preselected if present
        const want = (workbookSelect && workbookSelect.dataset && workbookSelect.dataset.preselected) || '';
        if (want && workbookSelect) workbookSelect.value = want;
        updateHighlights();
      });
      workbookSelect?.addEventListener('change', () => { updateLoadEnable(); updateHighlights(); });

      compareRepoSelect?.addEventListener('change', async () => {
        if (!compareRepoSelect || !compareWorkbookSelect) return;
        const repo = compareRepoSelect.value;
        compareWorkbookSelect.innerHTML = '<option value="">Select workbook</option>';
        if (repo) {
          try {
            const resp = await fetch(`/workbooks/${encodeURIComponent(repo)}`);
            if (resp.ok) {
              const files = await resp.json();
              files.forEach(f => {
                const opt = document.createElement('option');
                opt.value = f; opt.textContent = f; compareWorkbookSelect.appendChild(opt);
              });
              compareWorkbookSelect.disabled = files.length === 0;
            } else {
              compareWorkbookSelect.disabled = true;
            }
          } catch { compareWorkbookSelect.disabled = true; }
        } else {
          compareWorkbookSelect.disabled = true;
        }
        updateHighlights();
      });
      compareWorkbookSelect?.addEventListener('change', updateHighlights);

      // path helpers
      const isAbsolutePath = (p) => !!p && (p.startsWith('/') || /^[a-zA-Z]:[\\/]/.test(p));
      const getSep = (p) => (p && p.includes('\\') && !p.includes('/')) ? '\\' : '/';
      const ensureTrailing = (p) => { const s = getSep(p); return p.endsWith(s) ? p : p + s; };
      const parentDir = (p) => {
        if (!isAbsolutePath(p)) return '';
        const s = getSep(p);
        let q = p.endsWith(s) ? p.slice(0, -1) : p;
        const cut = q.lastIndexOf(s);
        return cut >= 0 ? q.slice(0, cut + 1) : '';
      };
      const driveRoot = (p) => {
        if (!isAbsolutePath(p)) return '';
        const s = getSep(p);
        const m = p.match(/^[a-zA-Z]:[\\/]/);
        return m ? m[0].replace(/[\\/]/, s) : s;
      };
      const handlePath = async (h) => {
        if (!h) return '';
        let p = '';
        if ('path' in h && h.path) p = String(h.path);
        else if ('fullPath' in h && h.fullPath) p = String(h.fullPath);
        else if ('nativePath' in h && h.nativePath) p = String(h.nativePath);
        else if ('fsPath' in h && h.fsPath) p = String(h.fsPath);
        if (!p) { try {
          for await (const [, entry] of h.entries()) {
            if (entry.kind === 'file') {
              const f = await entry.getFile();
              if (f && 'path' in f && f.path) {
                const fp = String(f.path);
                const sep = fp.includes('\\') ? '\\' : '/';
                p = fp.slice(0, fp.lastIndexOf(sep));
                break;
              }
            }
          }} catch(_) {}
        }
        if (!p) { try {
          const tmp = await h.getFileHandle('.codeset_tmp', { create: true });
          const f = await tmp.getFile();
          if (f && 'path' in f && f.path) {
            const fp = String(f.path); const sep = fp.includes('\\') ? '\\' : '/';
            p = fp.slice(0, fp.lastIndexOf(sep));
          }
          await h.removeEntry('.codeset_tmp');
        } catch(_) {} }
        if (!p) return '';
        if (p.startsWith('file://')) { try { p = new URL(p).pathname; } catch(_) { p = p.slice(7); } }
        if (p.startsWith('/') && /^[a-zA-Z]:/.test(p.slice(1))) p = p.slice(1);
        if (/^[a-zA-Z]:/.test(p)) p = p.replace(/\//g, '\\');
        return p;
      };
      const enableRepoButtons = () => {
        if (!repoBase || !repoLoad || !repoSave) return;
        const val = (repoBase.value || '').trim();
        const ok = isAbsolutePath(val);
        repoLoad.disabled = !ok; repoSave.disabled = !ok;
      };
      const cacheRootsIfAbsolute = () => {
        if (!repoBase) return;
        const v = (repoBase.value || '').trim();
        if (isAbsolutePath(v)) {
          localStorage.setItem('repoBaseParent', parentDir(v) || v);
          localStorage.setItem('repoBaseDrive', driveRoot(v) || '');
        }
      };
      repoBrowse?.addEventListener('click', async () => {
        if (!window.showDirectoryPicker) {
          alert('Your browser does not support Select Folder. Please paste an absolute path.');
          return;
        }
        try {
          const dirHandle = await window.showDirectoryPicker({ id: 'codeset-repo' });
          let fullPath = await handlePath(dirHandle);
          if (fullPath && isAbsolutePath(fullPath)) {
            repoBase.value = ensureTrailing(fullPath);
            cacheRootsIfAbsolute(); enableRepoButtons(); return;
          }
          const selectedName = dirHandle?.name || '';
          if (!selectedName) return;

          let base = '';
          const current = (repoBase.value || '').trim();
          if (isAbsolutePath(current)) base = ensureTrailing(parentDir(current) || current);
          if (!base) {
            const cachedParent = localStorage.getItem('repoBaseParent') || '';
            if (isAbsolutePath(cachedParent)) base = ensureTrailing(cachedParent);
          }
          if (!base) {
            const cachedDrive = localStorage.getItem('repoBaseDrive') || '';
            if (isAbsolutePath(cachedDrive) || /^[a-zA-Z]:[\\/]/.test(cachedDrive) || cachedDrive === '/')
              base = ensureTrailing(cachedDrive);
          }
          if (base) {
            repoBase.value = ensureTrailing(base + selectedName);
            cacheRootsIfAbsolute(); enableRepoButtons();
          } else {
            repoBase.value = selectedName; enableRepoButtons();
            alert('Full absolute path unavailable in browser. Paste an absolute path once (e.g., "C\\IntegrationServices\\") then use Select again.');
          }
        } catch(_) {}
      });
      repoBase?.addEventListener('input', () => { enableRepoButtons(); cacheRootsIfAbsolute(); });
      enableRepoButtons();

      // Run once on load to populate workbook list if needed (preserves current selection)
      primeRepo();
    }

    /* ---------- App wiring ---------- */
    document.addEventListener('DOMContentLoaded', () => {
      wireControls(document.getElementById('inline-controls'));
      wireControls(document.getElementById('overlay-controls'));

      // Hamburger menu (no Bootstrap)
      const hamburger = document.getElementById('hamburger');
      const menu = document.getElementById('headerMenu');
      const menuOpenControls = document.getElementById('menuOpenControls');
      const menuOpenTheme = document.getElementById('menuOpenTheme');
      function closeMenu(){ menu?.classList.add('d-none'); hamburger?.setAttribute('aria-expanded','false'); menu?.setAttribute('aria-hidden','true'); }
      function openMenu(){ menu?.classList.remove('d-none'); hamburger?.setAttribute('aria-expanded','true'); menu?.setAttribute('aria-hidden','false'); }
      hamburger?.addEventListener('click', (e)=>{ e.stopPropagation(); menu.classList.contains('d-none') ? openMenu() : closeMenu(); });
      document.addEventListener('click', (e)=>{ if (!menu || menu.classList.contains('d-none')) return; if (e.target===hamburger || menu.contains(e.target)) return; closeMenu(); });
      document.addEventListener('keydown', (e)=>{ if (e.key==='Escape') closeMenu(); });

      // Controls overlay
      const controlsOverlay = document.getElementById('controlsOverlay');
      const controlsOverlayClose = document.getElementById('overlayClose');
      const controlsOverlayDialog = controlsOverlay?.querySelector('.overlay-dialog');
      function openControlsOverlay(){
        if (!controlsOverlay) return;
        document.body.classList.add('no-scroll');
        controlsOverlay.classList.add('open');
        controlsOverlay.setAttribute('aria-hidden','false');
        (controlsOverlay.querySelector('input,select,button,[tabindex]:not([tabindex="-1"])')||controlsOverlay).focus();
      }
      function closeControlsOverlay(){
        if (!controlsOverlay) return;
        controlsOverlay.classList.remove('open');
        controlsOverlay.setAttribute('aria-hidden','true');
        document.body.classList.remove('no-scroll');
      }
      menuOpenControls?.addEventListener('click', ()=>{ closeMenu(); openControlsOverlay(); });
      controlsOverlayClose?.addEventListener('click', closeControlsOverlay);
      controlsOverlay?.querySelector('.overlay-backdrop')?.addEventListener('click', closeControlsOverlay);
      document.addEventListener('keydown', (e)=>{ if (e.key==='Escape' && controlsOverlay?.classList.contains('open')) closeControlsOverlay(); });
      controlsOverlayDialog?.addEventListener('click',(e)=>e.stopPropagation());

      // Theme overlay
      const themeOverlay = document.getElementById('themeOverlay');
      const themeOverlayClose = document.getElementById('themeOverlayClose');
      const themeOverlayDialog = themeOverlay?.querySelector('.overlay-dialog');
      function openThemeOverlay(){
        if (!themeOverlay) return;
        document.body.classList.add('no-scroll');
        themeOverlay.classList.add('open');
        themeOverlay.setAttribute('aria-hidden','false');
        (themeOverlay.querySelector('input,select,button,[tabindex]:not([tabindex="-1"])')||themeOverlay).focus();
      }
      function closeThemeOverlay(){
        if (!themeOverlay) return;
        themeOverlay.classList.remove('open');
        themeOverlay.setAttribute('aria-hidden','true');
        document.body.classList.remove('no-scroll');
      }
      menuOpenTheme?.addEventListener('click', ()=>{ closeMenu(); openThemeOverlay(); });
      themeOverlayClose?.addEventListener('click', closeThemeOverlay);
      themeOverlay?.querySelector('.overlay-backdrop')?.addEventListener('click', closeThemeOverlay);
      document.addEventListener('keydown', (e)=>{ if (e.key==='Escape' && themeOverlay?.classList.contains('open')) closeThemeOverlay(); });
      themeOverlayDialog?.addEventListener('click',(e)=>e.stopPropagation());

      // Show compare card in overlay without submitting
      const showCompareBtn = document.getElementById('btn-show-compare-modal');
      const compareCard = document.getElementById('compare-card-modal');
      showCompareBtn?.addEventListener('click', () => {
        if (!compareCard) return;
        compareCard.classList.remove('d-none');
        (compareCard.querySelector('.js-compare-repo, .js-compare-wb') || compareCard).focus();
      });

      /* ===== active sheet code (unchanged) ===== */
      const sheetSelector = document.getElementById('sheet-select');
      const errorsBox = document.getElementById('errors-box');
      const errorList = document.getElementById('error-list');
      const exportErrorsBtn = document.getElementById('export-errors');
      const fieldsBox = document.getElementById('fields-box');
      const fieldsText = document.getElementById('fields-text');

      const errorsPerSheet = {};
      function renderErrors() {
        if (!errorsBox || !errorList) return;
        const allErrors = Object.values(errorsPerSheet).flat();
        if (allErrors.length) {
          errorsBox.classList.remove('d-none');
          errorList.innerHTML = allErrors.map(e => `<li>${e}</li>`).join('');
          exportErrorsBtn?.classList.remove('d-none');
        } else {
          errorsBox.classList.add('d-none');
          errorList.innerHTML = '';
          exportErrorsBtn?.classList.add('d-none');
        }
      }
      function renderFieldNote(sheet) {
        if (!fieldsBox || !fieldsText) return;
        const note = fieldNotes[sheet] || '';
        if (note) { fieldsBox.classList.remove('d-none'); fieldsText.textContent = note; }
        else { fieldsBox.classList.add('d-none'); fieldsText.textContent = ''; }
      }
      function validateSheet(sheet) {
        const info = mappings[sheet] || {};
        const codeCol = info.code_col;
        const displayCol = info.display_col;
        const mappedCol = info.mapped_col;
        const rows = workbook[sheet] || [];
        const seenCodes = {};
        const errs = [];
        const table = document.querySelector('#table-wrapper table');
        const headerList = renderHeaders[sheet] || [];
        const codeIdx = headerList.indexOf(codeCol);
        const displayIdx = headerList.indexOf(displayCol);
        const mappedIdx = headerList.indexOf(mappedCol);
        if (table) table.querySelectorAll('td').forEach(td => td.classList.remove('error-cell'));
        rows.forEach((row, idx) => {
          const code    = String(row[codeCol] ?? '').trim();
          const display = String(row[displayCol] ?? '').trim();
          const mapped  = String(row[mappedCol] ?? '').trim();
          const tr = table ? table.tBodies[0].rows[idx] : null;
          if (code && !display) { errs.push(`On tab "${sheet}" - Code "${code}" does not have a display value`); if (tr && displayIdx !== -1) tr.children[displayIdx].classList.add('error-cell'); }
          if (display && !code) { errs.push(`On tab "${sheet}" - Display value "${display}" does not have a code`); if (tr && codeIdx !== -1) tr.children[codeIdx].classList.add('error-cell'); }
          if ((code || display) && !mapped) { errs.push(`On tab "${sheet}" - "${code || 'Row ' + (idx + 2)}" does not have a mapped standard description`); if (tr && mappedIdx !== -1) tr.children[mappedIdx].classList.add('error-cell'); }
          if (mapped && !code) { errs.push(`On tab "${sheet}" - Mapped standard description "${mapped}" does not have a code`); if (tr && codeIdx !== -1) tr.children[codeIdx].classList.add('error-cell'); }
          if (mapped && !display) { errs.push(`On tab "${sheet}" - Mapped standard description "${mapped}" does not have a display value`); if (tr && displayIdx !== -1) tr.children[displayIdx].classList.add('error-cell'); }
          if (code) {
            if (seenCodes[code] !== undefined) {
              errs.push(`On tab "${sheet}" - Code "${code}" is a duplicate code. All codes within a tab must be unique.`);
              if (tr && codeIdx !== -1) tr.children[codeIdx].classList.add('error-cell');
              const other = table ? table.tBodies[0].rows[seenCodes[code]] : null;
              if (other && codeIdx !== -1) other.children[codeIdx].classList.add('error-cell');
            } else { seenCodes[code] = idx; }
          }
        });
        errorsPerSheet[sheet] = errs;
        renderErrors();
      }
      function createInput(sheet, header, value = '') {
        if (header.endsWith('_COMPARE')) { const s = document.createElement('span'); s.textContent = value || ''; return s; }
        const key = header.toUpperCase().replace(/\s+/g, '_');
        const mapInfo = mappings[sheet] || {};
        const opts = dropdowns[sheet] && dropdowns[sheet][header];
        if (mapInfo.mapped_col && header === mapInfo.mapped_col && opts) {
          const sel = document.createElement('select');
          sel.className = 'mapped-select'; sel.dataset.sheet = sheet; sel.dataset.col = header;
          const blank = document.createElement('option'); blank.value = ''; blank.textContent = ''; if (!value) blank.selected = true;
          sel.appendChild(blank);
          opts.forEach(o => { const op = document.createElement('option'); op.value = o; op.textContent = o; if (o === value) op.selected = true; sel.appendChild(op); });
          return sel;
        }
        if (key === 'CODE' || key === 'DISPLAY_VALUE') { const i = document.createElement('input'); i.type='text'; i.value=value || ''; return i; }
        if (mapInfo.sub_col && header === mapInfo.sub_col) { const i = document.createElement('input'); i.type='text'; i.readOnly=true; i.value=value || ''; return i; }
        const s = document.createElement('span'); s.textContent = value || ''; return s;
      }
      function readSheet(table, sheet) {
        const baseRows = [], compRows = [];
        const allHeaders = renderHeaders[sheet];
        const mapInfo = mappings[sheet] || {};
        const hidden = mapInfo.hidden_cols || [];
        table.querySelectorAll('tbody tr').forEach((tr, rowIdx) => {
          const existingBase = (workbook[sheet] || [])[rowIdx] || {};
          const existingComp = (comparisonData[sheet] || [])[rowIdx] || {};
          const baseObj = { ...existingBase }, compObj = { ...existingComp };
          allHeaders.forEach((h, idx) => {
            const cell = tr.children[idx];
            const input = cell.querySelector('input, select');
            const val = input ? input.value : cell.textContent;
            if (h.endsWith('_COMPARE')) compObj[h] = val; else baseObj[h] = val;
          });
          hidden.forEach(h => { if (baseObj[h] === undefined) baseObj[h] = ''; });
          baseRows.push(baseObj); compRows.push(compObj);
        });
        return {baseRows, compRows};
      }
      function syncCurrentSheet() {
        const table = document.querySelector('#table-wrapper table');
        if (!table) return;
        const data = readSheet(table, currentSheet);
        workbook[currentSheet] = data.baseRows; comparisonData[currentSheet] = data.compRows;
      }
      function renderSheet(sheet) {
        const container = document.getElementById('table-wrapper');
        const buttons = document.getElementById('table-buttons');
        container.innerHTML = ''; buttons.innerHTML = '';

        const lockDiv = document.createElement('div'); lockDiv.className = 'mb-2';
        const lockBtn = document.createElement('button'); lockBtn.type='button'; lockBtn.className='btn btn-sm';
        const lockText = document.createElement('span'); lockText.className='ms-2';
        lockDiv.appendChild(lockBtn); lockDiv.appendChild(lockText); container.appendChild(lockDiv);

        const table = document.createElement('table');
        table.className = 'table table-bordered table-sm codeset-table';
        table.id = 'table-' + sheet.replace(/[^a-zA-Z0-9_]/g, '_');

        const thead = document.createElement('thead'); const headRow = document.createElement('tr');
        renderHeaders[sheet].forEach(h => {
          const th = document.createElement('th'); th.textContent = h.replace(/_/g, ' ');
          if (h.endsWith('_COMPARE')) th.classList.add('compare-col', 'compare-header'); headRow.appendChild(th);
        });
        thead.appendChild(headRow); table.appendChild(thead);

        const tbody = document.createElement('tbody');
        const rows = workbook[sheet] || [];
        rows.forEach((row, idx) => {
          const tr = document.createElement('tr');
          const comp = (comparisonData[sheet] || [])[idx] || {};
          renderHeaders[sheet].forEach(h => {
            const td = document.createElement('td');
            if (h.endsWith('_COMPARE')) td.classList.add('compare-col');
            const value = h.endsWith('_COMPARE') ? comp[h] : row[h];
            const input = createInput(sheet, h, value);
            td.appendChild(input); tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
        table.appendChild(tbody); container.appendChild(table);

        const addBtn = document.createElement('button');
        addBtn.className = 'btn btn-primary'; addBtn.textContent = 'Add Row';
        addBtn.addEventListener('click', () => {
          const tr = document.createElement('tr');
          renderHeaders[sheet].forEach(h => {
            const td = document.createElement('td');
            if (h.endsWith('_COMPARE')) td.classList.add('compare-col');
            const input = createInput(sheet, h); td.appendChild(input); tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
        buttons.appendChild(addBtn);

        const saveBtn = document.createElement('button');
        saveBtn.id='export-workbook'; saveBtn.className='btn btn-success'; saveBtn.textContent='Export Workbook';
        saveBtn.addEventListener('click', async () => {
          syncCurrentSheet(); validateSheet(currentSheet);
          const resp = await fetch('/export', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({data: workbook, locks: sheetLock}) });
          if (resp.ok) { await resp.json().catch(()=>{}); renderErrors(); alert('Workbook saved to repository'); }
          else {
            try {
              const data = await resp.json();
              if (data.errors) { errorsBox.classList.remove('d-none'); errorList.innerHTML = data.errors.map(e=>`<li>${e}</li>`).join(''); }
              else { errorsBox.classList.remove('d-none'); errorList.innerHTML = '<li>Export failed</li>'; }
            } catch { errorsBox.classList.remove('d-none'); errorList.innerHTML = '<li>Export failed</li>'; }
          }
        });
        buttons.appendChild(saveBtn);

        const importInput = document.createElement('input'); importInput.type='file'; importInput.accept='.xlsx'; importInput.style.display='none';
        const importBtn = document.createElement('button'); importBtn.type='button'; importBtn.className='btn btn-secondary'; importBtn.textContent='Import Workbook';
        importBtn.addEventListener('click', () => importInput.click());
        importInput.addEventListener('change', async () => {
          if (!importInput.files.length) return;
          const fd = new FormData(); fd.append('workbook', importInput.files[0]);
          const resp = await fetch('/import', { method:'POST', body: fd }); if (resp.ok) location.reload();
        });
        buttons.appendChild(importBtn); buttons.appendChild(importInput);

        function applyLockState(){
          const locked = sheetLock;
          lockBtn.textContent = locked ? '🔒' : '🔓';
          lockBtn.className = `btn btn-sm ${locked ? 'btn-lock-protected' : 'btn-lock-unprotected'}`;
          lockBtn.setAttribute('aria-pressed', String(locked));
          lockText.textContent = locked ? 'Sheet Protected' : 'Sheet Unprotected';
          table.querySelectorAll('input, select').forEach(el => { el.disabled = locked; });
          addBtn.disabled = locked;
        }
        lockBtn.addEventListener('click', () => { sheetLock = !sheetLock; applyLockState(); });
        applyLockState();
      }

      async function ensureSheetLoaded(sheet) {
        if (workbook[sheet]) return;
        const resp = await fetch(`/sheet/${encodeURIComponent(sheet)}`);
        if (resp.ok) {
          const rows = await resp.json();
          const baseRows = [], compRows = [];
          const hidden = (mappings[sheet] || {}).hidden_cols || [];
          rows.forEach(r => {
            const baseObj = {}, compObj = {};
            renderHeaders[sheet].forEach(h => {
              if (h.endsWith('_COMPARE')) compObj[h] = r[h] || ''; else baseObj[h] = r[h] || '';
            });
            hidden.forEach(h => { baseObj[h] = r[h] || ''; });
            baseRows.push(baseObj); compRows.push(compObj);
          });
          workbook[sheet] = baseRows; comparisonData[sheet] = compRows;
        } else { workbook[sheet] = []; comparisonData[sheet] = []; }
      }

      (async () => {
        if (initialSheet) {
          await ensureSheetLoaded(initialSheet);
          renderSheet(initialSheet);
          validateSheet(initialSheet);
          renderFieldNote(initialSheet);
        }
      })();

      sheetSelector?.addEventListener('change', async () => {
        syncCurrentSheet(); validateSheet(currentSheet);
        currentSheet = sheetSelector.value;
        await ensureSheetLoaded(currentSheet);
        renderSheet(currentSheet);
        validateSheet(currentSheet);
        renderFieldNote(currentSheet);
      });

      document.addEventListener('input', ev => {
        if (ev.target.closest('#table-wrapper')) { syncCurrentSheet(); validateSheet(currentSheet); }
      });
      document.addEventListener('change', ev => {
        const t = ev.target;
        if (t.classList?.contains('mapped-select')) {
          const sheet = t.dataset.sheet;
          const mapInfo = mappings[sheet]; if (!mapInfo) return;
          const mapping = mapInfo.map; const subCol = mapInfo.sub_col;
          const row = t.closest('tr');
          if (row && subCol) {
            const headerList = Array.from(row.closest('table').querySelectorAll('th')).map(th => th.innerText);
            const subIndex = headerList.indexOf(subCol);
            if (subIndex !== -1) {
              const cell = row.children[subIndex];
              const input = cell.querySelector('input, select');
              if (input) input.value = mapping[t.value] || ''; else cell.textContent = mapping[t.value] || '';
            }
          }
        }
        if (t.closest('#table-wrapper')) { syncCurrentSheet(); validateSheet(currentSheet); }
      });

      document.getElementById('export-errors')?.addEventListener('click', async () => {
        syncCurrentSheet(); validateSheet(currentSheet);
        const resp = await fetch('/export_errors', {
          method: 'POST', headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({data: workbook})
        });
        if (resp.ok) {
          const blob = await resp.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a'); a.href = url;
          const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
          a.download = `error_report_${ts}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        }
      });
    });
  </script>
</body>
</html>
