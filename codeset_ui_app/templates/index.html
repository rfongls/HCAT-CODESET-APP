<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Codeset Management System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap CSS (base styles only) -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
    crossorigin="anonymous"
  />
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />

</head>
<body>
  <header>
    <h1>Codeset Management System</h1>
    <div class="header-menu">
      <button id="hamburger" class="hamburger-btn" type="button"
              aria-haspopup="true" aria-expanded="false" aria-controls="headerMenu"
              aria-label="Open menu">â˜°</button>
      <div id="headerMenu" class="menu-pop d-none" role="menu" aria-hidden="true">
        {% if selected_workbook %}
        <button id="menuOpenControls" class="menu-item" role="menuitem" type="button">Select Repository</button>
        <button id="menuGenerateTransformer" class="menu-item" role="menuitem" type="button">Generate Codeset Transformer</button>
        {% endif %}
        <button id="menuOpenTheme" class="menu-item" role="menuitem" type="button">Theme</button>
      </div>
    </div>
  </header>

  <main class="container-fluid my-4">
    {% if error %}
    <div class="alert alert-danger" role="alert">{{ error }}</div>
    {% endif %}

    {% if pending_import_active %}
    {% set diff = pending_import or {} %}
    {% set diff_summary = diff.get('summary', {}) %}
    {% set diff_sheets = diff.get('sheets', {}) %}
    <section id="pending-import" class="section-card mb-3">
      <div class="section-title">Pending Workbook Import</div>
      <p class="mb-2">The uploaded workbook <strong>{{ pending_import_name or 'Pending Workbook' }}</strong> is
        staged. Review the side-by-side values in the grid below before applying.</p>
      {% if diff_sheets %}
      <p class="mb-3 small text-muted">
        {{ diff_summary.get('added', 0) }} addition{{ '' if diff_summary.get('added', 0) == 1 else 's' }},
        {{ diff_summary.get('removed', 0) }} removal{{ '' if diff_summary.get('removed', 0) == 1 else 's' }}, and
        {{ diff_summary.get('changed', 0) }} updated row{{ '' if diff_summary.get('changed', 0) == 1 else 's' }} across
        {{ diff_summary.get('total_sheets', 0) }} tab{{ '' if diff_summary.get('total_sheets', 0) == 1 else 's' }}.
      </p>
      {% else %}
      <p class="mb-3 small text-muted">No differences detected. Confirming will overwrite the workbook with the uploaded file.</p>
      {% endif %}

      <p class="mb-0 small">Use <em>Confirm All Changes</em> to replace the current workbook or <em>Cancel Import</em> to discard the staged file.</p>
      <div class="d-flex flex-wrap gap-2 mt-3">
        <button id="confirm-import-all" type="button" class="btn btn-success">Confirm All Changes</button>
        <button id="cancel-import" type="button" class="btn btn-outline-secondary">Cancel Import</button>
      </div>
    </section>
    {% endif %}

    {% if not selected_workbook %}
    <!-- LANDING CONTROLS (inline as before) -->
    <section id="inline-controls" class="mb-3">
      <div class="section-card">
        <form id="path-form-inline" method="post" class="row g-2 align-items-end mb-3">
          <div class="col-12 col-md-8">
            <label class="form-label"><b>Select repository folder</b></label>
            <div class="input-group">
              <input type="text" name="repo_base" class="form-control selected-primary js-repo-base"
                     value="{{ repo_base or '' }}" placeholder="Enter folder path" />
            </div>
          </div>
          <div class="col-12 col-md-2">
            <button type="submit" name="save_repo_base" value="1"
                    class="btn btn-primary w-100 js-repo-save">Load</button>
          </div>
        </form>

        <form id="repo-form-inline" method="post" class="row g-2 align-items-end">
          <div class="col-12 col-md-4">
            <label class="form-label"><b>Select the repository you want to edit a codeset for:</b></label>
            <!-- Yellow by default on landing -->
            <select name="repo"
                    class="form-select selected-primary js-repo-select {% if selected_repo %}selected-primary{% endif %}"
                    {% if not repositories %}disabled{% endif %}>
              <option value="">{% if repositories %}Select repository{% else %}Load a repository folder first{% endif %}</option>
              {% for repo in repositories or [] %}
              <option value="{{ repo }}" {% if repo == selected_repo %}selected{% endif %}>{{ repo_display[repo] }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-12 col-md-4">
            <label class="form-label"><b>Workbook</b></label>
            <!-- Yellow by default on landing -->
            <select name="workbook_name"
                    class="form-select selected-primary js-workbook-select {% if selected_workbook %}selected-primary{% endif %}"
                    {% if not repo_files %}disabled{% endif %}>
              <option value="">Select workbook</option>
              {% for wb in repo_files or [] %}
              <option value="{{ wb }}" {% if wb == selected_workbook %}selected{% endif %}>{{ wb }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-12 col-md-2">
            <button type="submit" class="btn btn-primary w-100 js-load-btn">Load Workbook</button>
          </div>
          {% if sheet_names and not compare_mode %}
          <div class="col-12 col-md-2">
            <button type="submit" name="start_compare" value="1" class="btn btn-primary w-100">Compare</button>
          </div>
          {% endif %}
        </form>

        {% if sheet_names and compare_mode %}
        <form id="compare-form-inline" method="post" class="row g-2 align-items-end mt-2">
          <div class="col-12 col-md-4">
            <select name="compare_repo" class="form-select selected-compare js-compare-repo {% if comparison_active %}selected-compare{% endif %}">
              <option value="">Select repository</option>
              {% for repo in (comparison_repositories or repositories or []) %}
              <option value="{{ repo }}" {% if repo == selected_compare_repo %}selected{% endif %}>{{ repo_display[repo] }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-12 col-md-4">
            <select name="compare_workbook_name"
                    class="form-select selected-compare js-compare-wb {% if comparison_active %}selected-compare{% endif %}"
                    {% if not compare_repo_files %}disabled{% endif %}>
              <option value="">Select workbook</option>
              {% for wb in compare_repo_files or [] %}
              <option value="{{ wb }}" {% if wb == selected_compare_workbook %}selected{% endif %}>{{ wb }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-12 col-md-2">
            {% if comparison_active %}
            <button type="submit" name="end_compare" value="1" class="btn btn-outline-secondary w-100">Clear Comparison</button>
            {% else %}
            <button type="submit" class="btn btn-primary w-100">Load Comparison</button>
            {% endif %}
          </div>
        </form>
        {% endif %}

        <form id="upload-form-inline" method="post" enctype="multipart/form-data" class="row g-2 align-items-center mt-2">
          <div class="col-12 col-md-8">
            <label for="upload-file-inline" class="form-control selected-primary text-truncate js-file-label" title="Choose File" style="cursor: pointer;">-- Click to Choose File --</label>
            <input id="upload-file-inline" type="file" name="workbook" accept=".xlsx" class="d-none js-file-input" />
          </div>
          <div class="col-12 col-md-2">
            <button type="submit" class="btn btn-outline-primary w-100">Upload</button>
          </div>
          <div class="d-none d-md-block col-md-2"></div>
        </form>
      </div>
    </section>
    {% endif %}

    {% if sheet_names %}
    <hr class="section-divider" aria-hidden="true">

    <div class="section-card" id="active-sheet-card">
      <div class="section-title">Active Sheet</div>

      <div id="sheet-toolbar" class="sheet-toolbar">
        <div class="row g-2 align-items-end">
          <div class="col-12 col-md-8">
            <select id="sheet-select" class="form-select">
              {% for sheet in sheet_names %}
              <option value="{{ sheet }}" {% if sheet == initial_sheet %}selected{% endif %}>{{ sheet }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="d-none d-md-block col-md-2"></div>
          <div class="d-none d-md-block col-md-2"></div>
        </div>
      </div>

      <div class="row">
        <div class="col-lg-9">
          <div id="table-wrapper" class="table-wrapper"></div>
          <div id="table-buttons" class="mt-2 d-flex gap-2"></div>
        </div>
        <div class="col-lg-3">
          <div id="fields-box" class="alert{% if not field_notes.get(initial_sheet) %} d-none{% endif %}">
            <h5 class="alert-heading fw-bold">Fields</h5>
            <p id="fields-text" class="mb-0">{{ field_notes.get(initial_sheet, '') }}</p>
          </div>
          <div id="requirements-box" class="alert alert-info">
            <h5 class="alert-heading fw-bold">Requirements</h5>
            <ul class="mb-0">
              <li>If CODE is populated, DISPLAY VALUE must be populated and vice versa.</li>
              <li>If STANDARD_CODE/STANDARD_DESCRIPTION exist, a MAPPED_STD_DESCRIPTION must be selected.</li>
              <li>If MAPPED_STD_DESCRIPTION is populated, CODE and DISPLAY VALUE must be provided.</li>
              <li>Codes must be unique within a tab.</li>
            </ul>
          </div>
          <div id="errors-box" class="alert alert-danger mt-3 d-none" aria-live="polite" aria-atomic="true">
            <h5 class="alert-heading fw-bold">Errors</h5>
            <ul id="error-list" class="mb-0"></ul>
            <button id="export-errors" class="btn btn-outline-danger btn-sm mt-2 d-none">Download Error Report</button>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
  </main>

  <!-- CONTROLS OVERLAY (for use AFTER workbook is loaded) -->
  <div id="controlsOverlay" class="overlay" aria-hidden="true">
    <div class="overlay-backdrop"></div>
    <div class="overlay-dialog" role="dialog" aria-modal="true" aria-labelledby="controlsOverlayTitle" tabindex="-1">
      <div class="overlay-header">
        <h5 id="controlsOverlayTitle" class="overlay-title">Select Repository</h5>
        <button id="overlayClose" type="button" class="overlay-header-close" aria-label="Close" title="Close">&times;</button>
      </div>
      <div class="overlay-body">
        <div id="overlay-controls" class="section-card">
          <!-- Repository & Workbook card -->
          <div id="repo-workbook-card-modal" class="section-card">

            <!-- path -->
            <form id="path-form-modal" method="post" class="row g-2 align-items-end mb-3">
              <input type="hidden" name="open_overlay" value="1" />
              <div class="col-12 col-md-8">
                <label class="form-label"><b>Select repository folder</b></label>
                <div class="input-group">
                  <input type="text" name="repo_base" class="form-control selected-primary js-repo-base"
                         value="{{ repo_base or '' }}" placeholder="Enter folder path" />
                </div>
              </div>
              <div class="col-12 col-md-2">
                <button type="submit" name="save_repo_base" value="1"
                        class="btn btn-primary w-100 js-repo-save">Load</button>
              </div>
            </form>

            <!-- repo/workbook -->
            <form id="repo-form-modal" method="post" class="row g-2 align-items-end">
              <input type="hidden" name="open_overlay" value="1" />
              <div class="col-12 col-md-4">
                <label class="form-label"><b>Select the repository you want to edit a codeset for:</b></label>
                <select name="repo"
                        class="form-select selected-primary js-repo-select {% if selected_repo %}selected-primary{% endif %}"
                        {% if not repositories %}disabled{% endif %}
                        data-preselected="{{ selected_repo or '' }}">
                  <option value="">{% if repositories %}Select repository{% else %}Load a repository folder first{% endif %}</option>
              {% for repo in repositories or [] %}
                  <option value="{{ repo }}" {% if repo == selected_repo %}selected{% endif %}>{{ repo_display[repo] }}</option>
              {% endfor %}
                </select>
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label"><b>Workbook</b></label>
                <select name="workbook_name"
                        class="form-select selected-primary js-workbook-select {% if selected_workbook %}selected-primary{% endif %}"
                        {% if not repo_files %}disabled{% endif %}
                        data-preselected="{{ selected_workbook or '' }}">
                  <option value="">Select workbook</option>
                  {% for wb in repo_files or [] %}
                  <option value="{{ wb }}" {% if wb == selected_workbook %}selected{% endif %}>{{ wb }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-12 col-md-2">
                <button type="submit" class="btn btn-primary w-100 js-load-btn">Load Workbook</button>
              </div>

              {% if sheet_names %}
              <div class="col-12 col-md-2">
                <!-- Shows compare UI without submitting -->
                <button id="btn-show-compare-modal" type="button" class="btn btn-primary w-100">Compare</button>
              </div>
              {% endif %}
            </form>
          </div>

          {% if sheet_names %}
          <!-- Comparison card -->
          <div id="compare-card-modal" class="section-card mt-3 {% if comparison_active %}{% else %}d-none{% endif %}">
            <div class="section-title">Comparison</div>
            <form id="compare-form-modal" method="post" class="row g-2 align-items-end">
              <input type="hidden" name="open_overlay" value="1" />
              <div class="col-12 col-md-4">
                <select name="compare_repo" class="form-select selected-compare js-compare-repo {% if comparison_active %}selected-compare{% endif %}">
                  <option value="">Select repository</option>
              {% for repo in (comparison_repositories or repositories or []) %}
                  <option value="{{ repo }}" {% if repo == selected_compare_repo %}selected{% endif %}>{{ repo_display[repo] }}</option>
              {% endfor %}
                </select>
              </div>
              <div class="col-12 col-md-4">
                <select name="compare_workbook_name"
                        class="form-select selected-compare js-compare-wb {% if comparison_active %}selected-compare{% endif %}"
                        {% if not compare_repo_files %}disabled{% endif %}>
                  <option value="">Select workbook</option>
                  {% for wb in compare_repo_files or [] %}
                  <option value="{{ wb }}" {% if wb == selected_compare_workbook %}selected{% endif %}>{{ wb }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-12 col-md-2">
                {% if comparison_active %}
                <button type="submit" name="end_compare" value="1" class="btn btn-outline-secondary w-100">Clear Comparison</button>
                {% else %}
                <button type="submit" class="btn btn-primary w-100">Load Comparison</button>
                {% endif %}
              </div>
            </form>
          </div>
          {% endif %}

          <div class="section-card mt-3">
            <div class="section-title">Upload</div>
            <form id="upload-form-modal" method="post" enctype="multipart/form-data" class="row g-2 align-items-center">
              <input type="hidden" name="open_overlay" value="1" />
              <div class="col-12 col-md-8">
                <label for="upload-file-modal" class="form-control selected-primary text-truncate js-file-label" title="Choose File" style="cursor: pointer;">-- Click to Choose File --</label>
                <input id="upload-file-modal" type="file" name="workbook" accept=".xlsx" class="d-none js-file-input" />
              </div>
              <div class="col-12 col-md-2">
                <button type="submit" class="btn btn-outline-primary w-100">Upload</button>
              </div>
              <div class="d-none d-md-block col-md-2"></div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- THEME OVERLAY -->
  <div id="themeOverlay" class="overlay" aria-hidden="true">
    <div class="overlay-backdrop"></div>
    <div class="overlay-dialog" role="dialog" aria-modal="true" aria-labelledby="themeOverlayTitle" tabindex="-1">
      <div class="overlay-header">
        <h5 id="themeOverlayTitle" class="overlay-title">Theme</h5>
        <button id="themeOverlayClose" type="button" class="overlay-header-close" aria-label="Close" title="Close">&times;</button>
      </div>
      <div class="overlay-body">
        <div class="section-card">
          <div class="section-title">Theme Selection</div>
          <select id="theme-select" class="form-select">
            <option value="light-purple">Light Purple</option>
            <option value="light-blue">Light Blue</option>
            <option value="light-gray">Light Gray</option>
            <option value="light-orange">Light Orange</option>
            <option value="light-pink">Light Pink</option>
            <option value="light-green">Light Green</option>
            <option value="dark-blue">Dark Blue</option>
            <option value="dark-purple">Dark Purple</option>
            <option value="dark-orange">Dark Orange</option>
            <option value="dark-green">Dark Green</option>
            <option value="dark-pink">Dark Pink</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-ZENmB1FQdJrEGAAtBqF7yqdv8cp8cYNjL6JTyAOuPBIYlFKE8ZFt5VtY3PQ9bFZV"
          crossorigin="anonymous"></script>

  <script>
    const themeSelect = document.getElementById('theme-select');
    const storedTheme = localStorage.getItem('theme') || 'light-purple';
    document.documentElement.setAttribute('data-theme', storedTheme);
    if (themeSelect) {
      themeSelect.value = storedTheme;
      themeSelect.addEventListener('change', (e) => {
        const theme = e.target.value;
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
      });
    }

    const mappings = {{ mappings|tojson }};
    const dropdowns = {{ dropdowns|tojson }};
    const headers = {{ headers|tojson }};
    const renderHeaders = {{ render_headers|tojson }};
    const fieldNotes = {{ field_notes|tojson }};
    const sheetNames = {{ sheet_names|tojson }};
    const initialSheet = {{ initial_sheet|tojson }};
    const initialErrors = {{ initial_errors|tojson }};
    const transformerUrl = {{ transformer_url|tojson }};
    window.initialErrors = initialErrors;
    const workbook = {};
    if (initialSheet) {
      workbook[initialSheet] = {{ base_records|tojson }};
    }
    const comparisonData = {};
    if (initialSheet) {
      comparisonData[initialSheet] = {{ compare_records|tojson }};
    }
    const originalFilename = {{ filename|tojson }};
    const hasSelectedWorkbook = {{ 'true' if selected_workbook else 'false' }};
    const undoStacks = {};
    const MAX_UNDO_ENTRIES = 20;
    const STANDARD_PLACEHOLDERS = new Set(['NA', 'N/A']);
    let sheetLock = false;
    let currentSheet = initialSheet;

    /* --- runtime sizing for sticky offsets --- */
    function setHeaderHeights() {
      const headerEl = document.querySelector('header');
      const height = headerEl ? headerEl.offsetHeight : 0;
      document.documentElement.style.setProperty('--app-header-height', `${height}px`);
      document.documentElement.style.setProperty('--header-height', `${height}px`);
    }
    setHeaderHeights();
    window.addEventListener('resize', setHeaderHeights);

    /* ---------- shared controls wiring (inline & overlay) ---------- */
    function wireControls(scope){
      if (!scope) return;

      const repoSelect = scope.querySelector('.js-repo-select');
      const workbookSelect = scope.querySelector('.js-workbook-select');
      const loadWorkbookBtn = scope.querySelector('.js-load-btn');
      const compareRepoSelect = scope.querySelector('.js-compare-repo');
      const compareWorkbookSelect = scope.querySelector('.js-compare-wb');

      const repoBase = scope.querySelector('.js-repo-base');
      const repoBrowse = scope.querySelector('.js-repo-browse');
      const repoLoad = scope.querySelector('.js-repo-load');
      const repoSave = scope.querySelector('.js-repo-save');
      const fileInput = scope.querySelector('.js-file-input');
      const fileLabel = scope.querySelector('.js-file-label');
      const defaultLabelText = fileLabel ? fileLabel.textContent : '';

      function updateLoadEnable(){
        const hasRepo = !!(repoSelect && !repoSelect.disabled && repoSelect.value);
        const hasWb   = !!(workbookSelect && !workbookSelect.disabled && workbookSelect.value);
        if (loadWorkbookBtn) loadWorkbookBtn.disabled = !(hasRepo && hasWb);
      }
      function updateHighlights(){
        if (repoBase) repoBase.classList.toggle('selected-primary', true);
        if (repoSelect) repoSelect.classList.toggle('selected-primary', true); // keep yellow
        if (workbookSelect) workbookSelect.classList.toggle('selected-primary', true);
        if (fileLabel) fileLabel.classList.toggle('selected-primary', true);
        if (compareRepoSelect) compareRepoSelect.classList.toggle('selected-compare', true);
        if (compareWorkbookSelect) compareWorkbookSelect.classList.toggle('selected-compare', true);
      }

      // Populate workbook list for a repo
      async function fillWorkbooksFor(repo) {
        if (!workbookSelect) return;
        workbookSelect.innerHTML = '<option value="">Select workbook</option>';
        if (!repo) { workbookSelect.disabled = true; updateLoadEnable(); return; }
        try {
          const resp = await fetch(`/workbooks/${encodeURIComponent(repo)}`);
          if (resp.ok) {
            const files = await resp.json();
            files.forEach(f => {
              const opt = document.createElement('option');
              opt.value = f; opt.textContent = f; workbookSelect.appendChild(opt);
            });
            workbookSelect.disabled = files.length === 0;
          } else {
            workbookSelect.disabled = true;
          }
        } catch {
          workbookSelect.disabled = true;
        }
        updateLoadEnable();
      }

      // If a repo is already selected on page load, prime without clearing a preselected workbook
      async function primeRepo(){
        updateHighlights();
        if (repoSelect && repoSelect.value) {
          // If the select already has a chosen workbook, don't refetch/clear
          const hasOptions = !!(workbookSelect && workbookSelect.options.length > 1);
          const hasChosen = hasOptions && Array.from(workbookSelect.options).some(o => o.selected && o.value);
          if (!hasOptions || !hasChosen) {
            await fillWorkbooksFor(repoSelect.value);
            const want = (workbookSelect && workbookSelect.dataset && workbookSelect.dataset.preselected) || '';
            if (want && workbookSelect) workbookSelect.value = want;
          }
        }
        updateLoadEnable();
      }

      repoSelect?.addEventListener('change', async () => {
        await fillWorkbooksFor(repoSelect.value);
        // Preserve preselected if present
        const want = (workbookSelect && workbookSelect.dataset && workbookSelect.dataset.preselected) || '';
        if (want && workbookSelect) workbookSelect.value = want;
        updateHighlights();
      });
      workbookSelect?.addEventListener('change', () => { updateLoadEnable(); updateHighlights(); });

      compareRepoSelect?.addEventListener('change', async () => {
        if (!compareRepoSelect || !compareWorkbookSelect) return;
        const repo = compareRepoSelect.value;
        compareWorkbookSelect.innerHTML = '<option value="">Select workbook</option>';
        if (repo) {
          try {
            const resp = await fetch(`/workbooks/${encodeURIComponent(repo)}`);
            if (resp.ok) {
              const files = await resp.json();
              files.forEach(f => {
                const opt = document.createElement('option');
                opt.value = f; opt.textContent = f; compareWorkbookSelect.appendChild(opt);
              });
              compareWorkbookSelect.disabled = files.length === 0;
            } else {
              compareWorkbookSelect.disabled = true;
            }
          } catch { compareWorkbookSelect.disabled = true; }
        } else {
          compareWorkbookSelect.disabled = true;
        }
        updateHighlights();
      });
      compareWorkbookSelect?.addEventListener('change', updateHighlights);

      fileInput?.addEventListener('change', () => {
        const name = fileInput.files.length
          ? fileInput.files[0].name
          : (defaultLabelText || 'Choose File');
        if (fileLabel) { fileLabel.textContent = name; fileLabel.title = name; }
      });

      // path helpers
      const isAbsolutePath = (p) => !!p && (p.startsWith('/') || /^[a-zA-Z]:[\\/]/.test(p));
      const getSep = (p) => (p && p.includes('\\') && !p.includes('/')) ? '\\' : '/';
      const ensureTrailing = (p) => { const s = getSep(p); return p.endsWith(s) ? p : p + s; };
      const parentDir = (p) => {
        if (!isAbsolutePath(p)) return '';
        const s = getSep(p);
        let q = p.endsWith(s) ? p.slice(0, -1) : p;
        const cut = q.lastIndexOf(s);
        return cut >= 0 ? q.slice(0, cut + 1) : '';
      };
      const driveRoot = (p) => {
        if (!isAbsolutePath(p)) return '';
        const s = getSep(p);
        const m = p.match(/^[a-zA-Z]:[\\/]/);
        return m ? m[0].replace(/[\\/]/, s) : s;
      };
      const handlePath = async (h) => {
        if (!h) return '';
        let p = '';
        if ('path' in h && h.path) p = String(h.path);
        else if ('fullPath' in h && h.fullPath) p = String(h.fullPath);
        else if ('nativePath' in h && h.nativePath) p = String(h.nativePath);
        else if ('fsPath' in h && h.fsPath) p = String(h.fsPath);
        if (!p) { try {
          for await (const [, entry] of h.entries()) {
            if (entry.kind === 'file') {
              const f = await entry.getFile();
              if (f && 'path' in f && f.path) {
                const fp = String(f.path);
                const sep = fp.includes('\\') ? '\\' : '/';
                p = fp.slice(0, fp.lastIndexOf(sep));
                break;
              }
            }
          }} catch(_) {}
        }
        if (!p) { try {
          const tmp = await h.getFileHandle('.codeset_tmp', { create: true });
          const f = await tmp.getFile();
          if (f && 'path' in f && f.path) {
            const fp = String(f.path); const sep = fp.includes('\\') ? '\\' : '/';
            p = fp.slice(0, fp.lastIndexOf(sep));
          }
          await h.removeEntry('.codeset_tmp');
        } catch(_) {} }
        if (!p) return '';
        if (p.startsWith('file://')) { try { p = new URL(p).pathname; } catch(_) { p = p.slice(7); } }
        if (p.startsWith('/') && /^[a-zA-Z]:/.test(p.slice(1))) p = p.slice(1);
        if (/^[a-zA-Z]:/.test(p)) p = p.replace(/\//g, '\\');
        return p;
      };
      const enableRepoButtons = () => {
        if (!repoBase || !repoSave || !repoLoad) return;
        const val = (repoBase.value || '').trim();
        const ok = isAbsolutePath(val);
        repoSave.disabled = !ok;
        repoLoad.disabled = !ok;
      };
      const cacheRootsIfAbsolute = () => {
        if (!repoBase) return;
        const v = (repoBase.value || '').trim();
        if (isAbsolutePath(v)) {
          localStorage.setItem('repoBaseParent', parentDir(v) || v);
          localStorage.setItem('repoBaseDrive', driveRoot(v) || '');
        }
      };
      repoBrowse?.addEventListener('click', async () => {
        if (!window.showDirectoryPicker) {
          alert('Your browser does not support Select Folder. Please paste an absolute path.');
          return;
        }
        try {
          const dirHandle = await window.showDirectoryPicker({ id: 'codeset-repo' });
          let fullPath = await handlePath(dirHandle);
          if (fullPath && isAbsolutePath(fullPath)) {
            repoBase.value = ensureTrailing(fullPath);
            cacheRootsIfAbsolute(); enableRepoButtons(); return;
          }
          const selectedName = dirHandle?.name || '';
          if (!selectedName) return;

          let base = '';
          const current = (repoBase.value || '').trim();
          if (isAbsolutePath(current)) base = ensureTrailing(parentDir(current) || current);
          if (!base) {
            const cachedParent = localStorage.getItem('repoBaseParent') || '';
            if (isAbsolutePath(cachedParent)) base = ensureTrailing(cachedParent);
          }
          if (!base) {
            const cachedDrive = localStorage.getItem('repoBaseDrive') || '';
            if (isAbsolutePath(cachedDrive) || /^[a-zA-Z]:[\\/]/.test(cachedDrive) || cachedDrive === '/')
              base = ensureTrailing(cachedDrive);
          }
          if (base) {
            repoBase.value = ensureTrailing(base + selectedName);
            cacheRootsIfAbsolute(); enableRepoButtons();
          } else {
            repoBase.value = selectedName; enableRepoButtons();
            alert('Full absolute path unavailable in browser. Paste an absolute path once (e.g., "C\\IntegrationServices\\") then use Select again.');
          }
        } catch(_) {}
      });
      repoBase?.addEventListener('input', () => { enableRepoButtons(); cacheRootsIfAbsolute(); });
      enableRepoButtons();

      // Run once on load to populate workbook list if needed (preserves current selection)
      primeRepo();
    }

    /* ---------- App wiring ---------- */
    const initApp = () => {
      const rootEl = document.documentElement;
      const headerEl = document.querySelector('header');
      const toolbarEl = document.getElementById('sheet-toolbar');

      function publishLayoutMetrics(){
        const headerHeight = headerEl ? headerEl.offsetHeight : 0;
        const toolbarHeight = toolbarEl ? toolbarEl.offsetHeight : 0;
        rootEl.style.setProperty('--app-header-height', `${headerHeight}px`);
        rootEl.style.setProperty('--sheet-toolbar-height', `${toolbarHeight}px`);
        rootEl.style.setProperty('--header-height', `${headerHeight}px`);
        rootEl.style.setProperty('--active-toolbar-offset', `${toolbarHeight}px`);
      }
      publishLayoutMetrics();
      window.addEventListener('resize', publishLayoutMetrics);

      async function switchSheet(newSheet) {
        if (!newSheet || newSheet === currentSheet) return;
        try {
          syncCurrentSheet();
          validateSheet(currentSheet);
        } catch (_) {}
        currentSheet = newSheet;
        await ensureSheetLoaded(currentSheet);
        renderSheet(currentSheet);
        validateSheet(currentSheet);
        try { renderFieldNote(currentSheet); } catch (_) {}
        try { publishLayoutMetrics(); } catch (_) {}
      }

      wireControls(document.getElementById('inline-controls'));
      wireControls(document.getElementById('overlay-controls'));

      // Hamburger menu (no Bootstrap)
      const hamburger = document.getElementById('hamburger');
      const menu = document.getElementById('headerMenu');
      const menuOpenControls = document.getElementById('menuOpenControls');
      const menuGenerateTransformer = document.getElementById('menuGenerateTransformer');
      const menuOpenTheme = document.getElementById('menuOpenTheme');
      function closeMenu(){
        menu?.classList.add('d-none');
        hamburger?.setAttribute('aria-expanded','false');
        menu?.setAttribute('aria-hidden','true');
      }
      function openMenu(){
        menu?.classList.remove('d-none');
        hamburger?.setAttribute('aria-expanded','true');
        menu?.setAttribute('aria-hidden','false');
        const firstItem = menu?.querySelector('.menu-item');
        if (firstItem) {
          requestAnimationFrame(() => firstItem.focus());
        }
      }
      hamburger?.addEventListener('click', (e)=>{
        if (!menu) return;
        e.stopPropagation();
        menu.classList.contains('d-none') ? openMenu() : closeMenu();
      });
      document.addEventListener('click', (e)=>{ if (!menu || menu.classList.contains('d-none')) return; if (e.target===hamburger || menu.contains(e.target)) return; closeMenu(); });
      document.addEventListener('keydown', (e)=>{ if (e.key==='Escape') closeMenu(); });

      // Controls overlay
      const controlsOverlay = document.getElementById('controlsOverlay');
      const controlsOverlayClose = document.getElementById('overlayClose');
      const controlsOverlayDialog = controlsOverlay?.querySelector('.overlay-dialog');
      function openControlsOverlay(){
        if (!controlsOverlay) return;
        document.body.classList.add('no-scroll');
        controlsOverlay.classList.add('open');
        controlsOverlay.setAttribute('aria-hidden','false');
        const focusTarget = controlsOverlay.querySelector('input,select,button,[tabindex]:not([tabindex="-1"])');
        if (focusTarget) {
          requestAnimationFrame(() => focusTarget.focus());
        }
      }
      function closeControlsOverlay(){
        if (!controlsOverlay) return;
        controlsOverlay.classList.remove('open');
        controlsOverlay.setAttribute('aria-hidden','true');
        document.body.classList.remove('no-scroll');
        if (document.activeElement && controlsOverlay.contains(document.activeElement)) {
          menuOpenControls?.focus();
        }
      }
      menuOpenControls?.addEventListener('click', ()=>{ closeMenu(); openControlsOverlay(); });
      menuGenerateTransformer?.addEventListener('click', () => {
        closeMenu();
        if (transformerUrl) {
          window.location.href = transformerUrl;
          return;
        }
        if (typeof window.openCodesetTransformer === 'function') {
          window.openCodesetTransformer();
          return;
        }
        if (typeof window.generateCodesetTransformer === 'function') {
          window.generateCodesetTransformer();
          return;
        }
        const trigger =
          document.querySelector('#open-transformer-btn') ||
          document.querySelector('[data-action="open-transformer"]') ||
          document.querySelector('[data-testid="open-transformer"]');
        if (trigger) {
          trigger.click();
          return;
        }
        const section =
          document.getElementById('codeset-transformer') ||
          document.getElementById('transformer-card') ||
          document.querySelector('[data-section="codeset-transformer"]');
        if (section) {
          section.classList.remove('d-none', 'collapsed');
          try { section.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch {}
          return;
        }
        window.location.href = '/transformer';
      });
      controlsOverlayClose?.addEventListener('click', (e)=>{ e.preventDefault(); closeControlsOverlay(); });
      controlsOverlay?.querySelector('.overlay-backdrop')?.addEventListener('click', closeControlsOverlay);
      document.addEventListener('keydown', (e)=>{ if (e.key==='Escape' && controlsOverlay?.classList.contains('open')) closeControlsOverlay(); });
      controlsOverlayDialog?.addEventListener('click',(e)=>e.stopPropagation());
      const reopenControls = {{ 'true' if reopen_controls else 'false' }};
      if (reopenControls) openControlsOverlay();

      // Theme overlay
      const themeOverlay = document.getElementById('themeOverlay');
      const themeOverlayClose = document.getElementById('themeOverlayClose');
      const themeOverlayDialog = themeOverlay?.querySelector('.overlay-dialog');
      function openThemeOverlay(){
        if (!themeOverlay) return;
        document.body.classList.add('no-scroll');
        themeOverlay.classList.add('open');
        themeOverlay.setAttribute('aria-hidden','false');
        const focusTarget = themeOverlay.querySelector('input,select,button,[tabindex]:not([tabindex="-1"])');
        if (focusTarget) {
          requestAnimationFrame(() => focusTarget.focus());
        }
      }
      function closeThemeOverlay(){
        if (!themeOverlay) return;
        themeOverlay.classList.remove('open');
        themeOverlay.setAttribute('aria-hidden','true');
        document.body.classList.remove('no-scroll');
        if (document.activeElement && themeOverlay.contains(document.activeElement)) {
          menuOpenTheme?.focus();
        }
      }
      menuOpenTheme?.addEventListener('click', ()=>{ closeMenu(); openThemeOverlay(); });
      themeOverlayClose?.addEventListener('click', (e)=>{ e.preventDefault(); closeThemeOverlay(); });
      themeOverlay?.querySelector('.overlay-backdrop')?.addEventListener('click', closeThemeOverlay);
      document.addEventListener('keydown', (e)=>{ if (e.key==='Escape' && themeOverlay?.classList.contains('open')) closeThemeOverlay(); });
      themeOverlayDialog?.addEventListener('click',(e)=>e.stopPropagation());

      // Show compare card in overlay without submitting
      const showCompareBtn = document.getElementById('btn-show-compare-modal');
      const compareCard = document.getElementById('compare-card-modal');
      showCompareBtn?.addEventListener('click', () => {
        if (!compareCard) return;
        compareCard.classList.remove('d-none');
        (compareCard.querySelector('.js-compare-repo, .js-compare-wb') || compareCard).focus();
      });

      /* ===== active sheet code (unchanged) ===== */
      const sheetSelector = document.getElementById('sheet-select');
      const errorsBox = document.getElementById('errors-box');
      const errorList = document.getElementById('error-list');
      const exportErrorsBtn = document.getElementById('export-errors');
      const fieldsBox = document.getElementById('fields-box');
      const fieldsText = document.getElementById('fields-text');

      const errorsPerSheet = {};
      window.errorsPerSheet = errorsPerSheet;

      function getUndoStack(sheet) {
        if (!undoStacks[sheet]) {
          undoStacks[sheet] = [];
        }
        return undoStacks[sheet];
      }

      function pushUndoSnapshot(sheet) {
        if (!sheet) return;
        const stack = getUndoStack(sheet);
        const snapshot = {
          workbook: JSON.parse(JSON.stringify(workbook[sheet] || [])),
          comparison: JSON.parse(JSON.stringify(comparisonData[sheet] || [])),
        };
        stack.push(snapshot);
        if (stack.length > MAX_UNDO_ENTRIES) {
          stack.shift();
        }
      }

      function normalizeValue(val) {
        return String(val ?? '').trim();
      }

      function hasMeaningfulStandard(value) {
        if (!value) return false;
        return !STANDARD_PLACEHOLDERS.has(value.toUpperCase());
      }

      function formatClientError(sheet, rowLabel, detail) {
        const label = typeof rowLabel === 'number' ? `Row ${rowLabel}` : rowLabel;
        return `Tab "${sheet}" - ${label} - ${detail}`;
      }
      function renderErrors() {
        if (!errorsBox || !errorList) return;
        const allErrors = Object.values(errorsPerSheet).flat();
        if (allErrors.length) {
          errorsBox.classList.remove('d-none');
          errorList.innerHTML = allErrors.map(e => `<li>${e}</li>`).join('');
          exportErrorsBtn?.classList.remove('d-none');
        } else {
          errorsBox.classList.add('d-none');
          errorList.innerHTML = '';
          exportErrorsBtn?.classList.add('d-none');
        }
      }

      const TARGET_COLUMNS = ['CODE', 'DISPLAY VALUE', 'SUBDEFINITION', 'MAPPED STD DESCRIPTION'];
      const TARGET_COLUMN_SET = new Set(TARGET_COLUMNS);

      function norm(value) {
        return String(value || '').replace(/_/g, ' ').trim().toUpperCase();
      }

      function isTargetCol(header) {
        return TARGET_COLUMN_SET.has(norm(header));
      }

      const escapeHeaderSelector = (value) => {
        if (typeof CSS !== 'undefined' && CSS.escape) {
          return CSS.escape(value);
        }
        return String(value).replace(/[^a-zA-Z0-9_-]/g, match => `\\${match}`);
      };

      function getTargetHeaders(sheet) {
        return (renderHeaders[sheet] || []).filter(isTargetCol);
      }

      /* --- helpers to set a cell's UI value without re-rendering --- */
      function setCellUiValueByHeader(tr, header, value) {
        const cell = tr?.querySelector(`td[data-col="${escapeHeaderSelector(header)}"]`);
        if (!cell) return;
        const control = cell.querySelector('input, select, textarea');
        if (control) {
          if (control.tagName === 'SELECT') {
            // best-effort select: choose matching option else fallback to index 0
            const idx = Array.from(control.options).findIndex(o => o.value === value || o.text === value);
            control.selectedIndex = idx >= 0 ? idx : 0;
          } else {
            control.value = value ?? '';
          }
          control.dispatchEvent(new Event('input', { bubbles: true }));
          control.dispatchEvent(new Event('change', { bubbles: true }));
        } else {
          cell.textContent = value ?? '';
        }
      }

      /* --- core: compact target columns downward starting at rowIndex --- */
      function compactTargetColumnsFromRow(sheet, rowIndex) {
        const headers = getTargetHeaders(sheet);
        if (!headers.length) return false;
        const baseRows = workbook[sheet] || [];
        if (!baseRows.length || rowIndex < 0 || rowIndex >= baseRows.length) return false;

        let changed = false;
        // Build new column arrays -> shift up -> write back
        headers.forEach(header => {
          const colVals = baseRows.map(r => (r?.[header] ?? ''));
          // remove the clicked row's value and push an empty at end
          colVals.splice(rowIndex, 1);
          colVals.push('');
          // write back into the model
          for (let i = 0; i < baseRows.length; i++) {
            if (baseRows[i][header] !== colVals[i]) {
              baseRows[i][header] = colVals[i];
              changed = true;
            }
          }
        });

        // Update DOM in-place (avoid a full re-render / scroll jump)
        const table = document.querySelector('#table-wrapper table');
        const tbody = table?.tBodies?.[0];
        if (tbody) {
          const rows = Array.from(tbody.rows);
          headers.forEach(header => {
            // recompute from model to avoid redoing the splice logic
            for (let i = 0; i < rows.length; i++) {
              const v = (baseRows[i]?.[header] ?? '');
              setCellUiValueByHeader(rows[i], header, v);
            }
          });
        }
        return changed;
      }

      function rowHasTargetValues(sheet, rowObj, tr) {
        const headers = getTargetHeaders(sheet);
        if (!headers.length) return false;
        return headers.some(header => {
          if (rowObj && norm(rowObj[header]) !== '') return true;
          if (!tr) return false;
          const cell = tr.querySelector(`td[data-col="${escapeHeaderSelector(header)}"]`);
          if (!cell) return false;
          const control = cell.querySelector('input, select, textarea');
          if (control) {
            return norm(control.value) !== '';
          }
          return norm(cell.textContent) !== '';
        });
      }

      function clearTargetsInRow(sheet, rowObj) {
        if (!rowObj) return false;
        const headers = getTargetHeaders(sheet);
        if (!headers.length) return false;
        let changed = false;
        headers.forEach(header => {
          if (norm(rowObj[header]) !== '') {
            rowObj[header] = '';
            changed = true;
          }
        });
        return changed;
      }

      function sheetHasTargetValues(sheet) {
        const headers = getTargetHeaders(sheet);
        if (!headers.length) return false;
        const baseRows = workbook[sheet] || [];
        const hasStored = baseRows.some(row => {
          if (!row) return false;
          return headers.some(header => norm(row[header]) !== '');
        });
        if (hasStored) return true;
        const table = document.querySelector('#table-wrapper table');
        if (table && table.tBodies[0]) {
          return Array.from(table.tBodies[0].rows).some(tr => rowHasTargetValues(sheet, null, tr));
        }
        return false;
      }

      function clearTargetsInDOMRow(tr, sheet) {
        if (!tr) return false;
        const headers = getTargetHeaders(sheet);
        if (!headers.length) return false;
        let changed = false;
        headers.forEach(header => {
          const cell = tr.querySelector(`td[data-col="${escapeHeaderSelector(header)}"]`);
          if (!cell) return;
          const control = cell.querySelector('input, select, textarea');
          if (control) {
            const prevValue = control.value;
            if (prevValue !== '') {
              if (control.tagName === 'SELECT') {
                control.selectedIndex = 0;
              } else {
                control.value = '';
              }
              control.dispatchEvent(new Event('input', { bubbles: true }));
              control.dispatchEvent(new Event('change', { bubbles: true }));
              changed = true;
            }
          } else {
            const prev = cell.textContent || '';
            if (norm(prev) !== '') {
              cell.textContent = '';
              changed = true;
            }
          }
        });
        return changed;
      }

      function clearAllRowsValues(sheet, table) {
        const headers = getTargetHeaders(sheet);
        if (!headers.length) return false;
        const baseRows = workbook[sheet] || [];
        let changed = false;

        baseRows.forEach(row => {
          if (!row) return;
          headers.forEach(header => {
            if (norm(row[header]) !== '') {
              row[header] = '';
              changed = true;
            }
          });
        });

        const tableEl = table && table.tBodies ? table : document.querySelector('#table-wrapper table');
        if (tableEl && tableEl.tBodies[0]) {
          Array.from(tableEl.tBodies[0].rows).forEach(tr => {
            if (clearTargetsInDOMRow(tr, sheet)) {
              changed = true;
            }
          });
        }

        return changed;
      }

      function seedInitialErrors() {
        if (!Array.isArray(initialErrors) || !initialErrors.length) return;
        initialErrors.forEach(message => {
          if (typeof message !== 'string') return;
          const match = message.match(/^Tab "(.+?)" - /);
          const sheet = match ? match[1] : null;
          if (!sheet) return;
          const list = errorsPerSheet[sheet] || (errorsPerSheet[sheet] = []);
          if (!list.includes(message)) {
            list.push(message);
          }
        });
        renderErrors();
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', seedInitialErrors, { once: true });
      } else {
        seedInitialErrors();
      }
      function renderFieldNote(sheet) {
        if (!fieldsBox || !fieldsText) return;
        const note = fieldNotes[sheet] || '';
        if (note) { fieldsBox.classList.remove('d-none'); fieldsText.textContent = note; }
        else { fieldsBox.classList.add('d-none'); fieldsText.textContent = ''; }
      }
      function validateSheet(sheet) {
        const info = mappings[sheet] || {};
        const codeCol = info.code_col;
        const displayCol = info.display_col;
        const mappedCol = info.mapped_col;
        const rows = workbook[sheet] || [];
        const errs = [];
        const table = document.querySelector('#table-wrapper table');
        const headerList = renderHeaders[sheet] || [];
        const codeIdx = codeCol ? headerList.indexOf(codeCol) : -1;
        const displayIdx = displayCol ? headerList.indexOf(displayCol) : -1;
        const mappedIdx = mappedCol ? headerList.indexOf(mappedCol) : -1;
        const tbody = table ? table.tBodies[0] : null;
        const codeToRows = {};

        if (table) {
          table.querySelectorAll('td').forEach(td => td.classList.remove('error-cell'));
        }

        rows.forEach((row, idx) => {
          const rowNum = idx + 2;
          const code = codeCol ? normalizeValue(row[codeCol]) : '';
          const display = displayCol ? normalizeValue(row[displayCol]) : '';
          const mapped = mappedCol ? normalizeValue(row[mappedCol]) : '';
          const stdCode = stdCodeCol ? normalizeValue(row[stdCodeCol]) : '';
          const stdDesc = stdDescCol ? normalizeValue(row[stdDescCol]) : '';
          const hasStandard = hasMeaningfulStandard(stdCode) || hasMeaningfulStandard(stdDesc);
          const rowEl = tbody && tbody.rows ? tbody.rows[idx] : null;

          if (code) {
            (codeToRows[code] = codeToRows[code] || []).push(idx);
          }

          if (code && !display) {
            errs.push(formatClientError(sheet, rowNum, `Code '${code}' is missing a display value`));
            if (rowEl && displayIdx > -1) rowEl.children[displayIdx].classList.add('error-cell');
          }

          if (display && !code) {
            errs.push(formatClientError(sheet, rowNum, `Display value '${display}' is missing a code`));
            if (rowEl && codeIdx > -1) rowEl.children[codeIdx].classList.add('error-cell');
          }

          if (hasStandard && (code || display) && !mapped) {
            const mappedLabel = (mappedCol || 'MAPPED_STD_DESCRIPTION').replace(/_/g, ' ');
            const detail = code
              ? `${mappedLabel} is required when a standard code/description is present for code '${code}'`
              : `${mappedLabel} is required when a standard code/description is present`;
            errs.push(formatClientError(sheet, rowNum, detail));
            if (rowEl && mappedIdx > -1) rowEl.children[mappedIdx].classList.add('error-cell');
          }

          if (mapped && !code) {
            errs.push(formatClientError(sheet, rowNum, `Mapped standard description '${mapped}' is missing a code`));
            if (rowEl && codeIdx > -1) rowEl.children[codeIdx].classList.add('error-cell');
          }

          if (mapped && !display && !(code && !display)) {
            errs.push(formatClientError(sheet, rowNum, `Mapped standard description '${mapped}' is missing a display value`));
            if (rowEl && displayIdx > -1) rowEl.children[displayIdx].classList.add('error-cell');
          }
        });

        Object.entries(codeToRows).forEach(([code, indexes]) => {
          if (!indexes || indexes.length < 2) return;
          indexes.forEach((rowIdx, pos) => {
            const others = indexes.filter((_, i) => i !== pos).map(i => i + 2);
            const detail = others.length === 1
              ? `Code '${code}' duplicates row ${others[0]}`
              : `Code '${code}' duplicates rows ${others.join(', ')}`;
            errs.push(formatClientError(sheet, rowIdx + 2, detail));
            if (tbody && codeIdx > -1 && tbody.rows[rowIdx]) {
              tbody.rows[rowIdx].children[codeIdx].classList.add('error-cell');
            }
          });
        });

        errorsPerSheet[sheet] = errs;
        renderErrors();
      }
      function createInput(sheet, header, value = '') {
        const mapInfo = mappings[sheet] || {};
        const opts = dropdowns[sheet] && dropdowns[sheet][header];
        if (header.endsWith('_COMPARE')) {
          const span = document.createElement('span');
          span.className = 'cell-text';
          span.textContent = value || '';
          return span;
        }
        const key = header.toUpperCase().replace(/\s+/g, '_');
        if (mapInfo.mapped_col && header === mapInfo.mapped_col && opts) {
          const sel = document.createElement('select');
          sel.className = 'cell-select mapped-select';
          sel.dataset.sheet = sheet;
          sel.dataset.col = header;
          const blank = document.createElement('option');
          blank.value = '';
          blank.textContent = '';
          if (!value) blank.selected = true;
          sel.appendChild(blank);
          opts.forEach(optionValue => {
            const option = document.createElement('option');
            option.value = optionValue;
            option.textContent = optionValue;
            if (optionValue === value) option.selected = true;
            sel.appendChild(option);
          });
          return sel;
        }
        if (key === 'CODE' || key === 'DISPLAY_VALUE') {
          const input = document.createElement('input');
          input.type = 'text';
          input.value = value || '';
          input.className = 'cell-input';
          return input;
        }
        if (mapInfo.sub_col && header === mapInfo.sub_col) {
          const input = document.createElement('input');
          input.type = 'text';
          input.readOnly = true;
          input.value = value || '';
          input.className = 'cell-input';
          return input;
        }
        const span = document.createElement('span');
        span.className = 'cell-text';
        span.textContent = value || '';
        return span;
      }
      function readSheet(table, sheet) {
        const baseRows = [], compRows = [];
        const allHeaders = renderHeaders[sheet];
        const mapInfo = mappings[sheet] || {};
        const hidden = mapInfo.hidden_cols || [];
        table.querySelectorAll('tbody tr').forEach((tr, rowIdx) => {
          const existingBase = (workbook[sheet] || [])[rowIdx] || {};
          const existingComp = (comparisonData[sheet] || [])[rowIdx] || {};
          const baseObj = { ...existingBase }, compObj = { ...existingComp };
          allHeaders.forEach((h, idx) => {
            const cell = tr.children[idx + 1];
            const input = cell.querySelector('input, select');
            const val = input ? input.value : cell.textContent;
            if (h.endsWith('_COMPARE')) compObj[h] = val; else baseObj[h] = val;
          });
          hidden.forEach(h => { if (baseObj[h] === undefined) baseObj[h] = ''; });
          baseRows.push(baseObj); compRows.push(compObj);
        });
        return {baseRows, compRows};
      }

      function createEmptyBaseRow(sheet) {
        const baseRow = {};
        (renderHeaders[sheet] || []).forEach(header => {
          if (!header.endsWith('_COMPARE')) {
            baseRow[header] = '';
          }
        });
        const info = mappings[sheet] || {};
        (info.hidden_cols || []).forEach(col => {
          if (baseRow[col] === undefined) {
            baseRow[col] = '';
          }
        });
        return baseRow;
      }

      function createEmptyComparisonRow(sheet) {
        const compRow = {};
        (renderHeaders[sheet] || []).forEach(header => {
          if (header.endsWith('_COMPARE')) {
            compRow[header] = '';
          }
        });
        return compRow;
      }

      function isSheetEmpty(sheet) {
        const rows = workbook[sheet] || [];
        if (!rows.length) {
          return true;
        }
        return rows.every(row => {
          return Object.values(row || {}).every(value => normalizeValue(value) === '');
        });
      }
      function syncCurrentSheet() {
        const table = document.querySelector('#table-wrapper table');
        if (!table) return;
        const data = readSheet(table, currentSheet);
        workbook[currentSheet] = data.baseRows; comparisonData[currentSheet] = data.compRows;
      }
      function clearColumnHighlight(table) {
        if (!table) return;
        table.querySelectorAll('.column-highlight').forEach(cell => cell.classList.remove('column-highlight'));
      }
      function enableColumnHighlight(table) {
        if (!table) return;
        table.addEventListener('focusin', event => {
          const cell = event.target.closest('td, th');
          if (!cell || typeof cell.cellIndex !== 'number') return;
          if (event.target.closest('.no-col-highlight')) return;
          clearColumnHighlight(table);
          cell.classList.add('column-highlight');
        });
        table.addEventListener('focusout', () => {
          requestAnimationFrame(() => {
            if (!table.contains(document.activeElement)) {
              clearColumnHighlight(table);
            }
          });
        });
      }
      function renderSheet(sheet) {
        const container = document.getElementById('table-wrapper');
        const buttons = document.getElementById('table-buttons');
        if (!container || !buttons) return;
        container.classList.add('table-wrapper');
        container.innerHTML = '';
        buttons.innerHTML = '';

        if (!workbook[sheet]) workbook[sheet] = [];
        if (!comparisonData[sheet]) comparisonData[sheet] = [];
        const baseRows = workbook[sheet];
        const compRows = comparisonData[sheet];

        let rowCount = Math.max(baseRows.length, compRows.length);
        if (rowCount === 0) {
          rowCount = 1;
        }
        while (baseRows.length < rowCount) {
          baseRows.push(createEmptyBaseRow(sheet));
        }
        while (compRows.length < rowCount) {
          compRows.push(createEmptyComparisonRow(sheet));
        }

        const lockDiv = document.createElement('div');
        lockDiv.className = 'mb-2';
        const lockBtn = document.createElement('button');
        lockBtn.type = 'button';
        lockBtn.className = 'btn btn-sm';
        const lockText = document.createElement('span');
        lockText.className = 'ms-2';
        lockDiv.appendChild(lockBtn);
        lockDiv.appendChild(lockText);
        container.appendChild(lockDiv);

        const scrollContainer = document.createElement('div');
        scrollContainer.className = 'table-scroll';

        const headerIndexMap = {};
        renderHeaders[sheet].forEach((header, idx) => {
          headerIndexMap[header] = idx;
        });

        const comparePartnerFor = {};
        const basePartnerFor = {};
        let lastBaseHeader = null;
        renderHeaders[sheet].forEach(header => {
          if (header.endsWith('_COMPARE')) {
            if (lastBaseHeader) {
              comparePartnerFor[lastBaseHeader] = header;
              basePartnerFor[header] = lastBaseHeader;
            }
          } else {
            lastBaseHeader = header;
          }
        });

        const table = document.createElement('table');
        table.className = 'table table-bordered table-sm codeset-table';
        table.id = 'table-' + sheet.replace(/[^a-zA-Z0-9_]/g, '_');

        const thead = document.createElement('thead');
        const headRow = document.createElement('tr');
        renderHeaders[sheet].forEach(header => {
          const th = document.createElement('th');
          th.textContent = header.replace(/_/g, ' ');
          if (header.endsWith('_COMPARE')) {
            th.classList.add('compare-col', 'compare-header');
          }
          headRow.appendChild(th);
        });
        thead.appendChild(headRow);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        const codeColName = (mappings[sheet] || {}).code_col;
        let undoBtn;

        function buildRow(baseRow, compRow, rowIndex) {
          const tr = document.createElement('tr');
          renderHeaders[sheet].forEach(header => {
            const td = document.createElement('td');
            td.dataset.col = header;
            if (header.endsWith('_COMPARE')) {
              td.classList.add('compare-col');
              if (basePartnerFor[header]) {
                td.dataset.baseTarget = basePartnerFor[header];
              }
            }
            const value = header.endsWith('_COMPARE') ? (compRow ? compRow[header] : '') : (baseRow ? baseRow[header] : '');
            const input = createInput(sheet, header, value);
            if (!header.endsWith('_COMPARE') && header === codeColName) {
              td.classList.add('clearable-cell');
              const clearBtn = document.createElement('button');
              clearBtn.type = 'button';
              clearBtn.className = 'clear-row-btn';
              clearBtn.setAttribute('aria-label', 'Clear values & shift up');
              clearBtn.classList.add('no-col-highlight');
              clearBtn.title = 'Clear values & shift up';
              clearBtn.textContent = 'Ã—';
              clearBtn.addEventListener('click', () => {
                if (sheetLock) return;
                // column-wise compaction: clear/shift only target columns
                pushUndoSnapshot(sheet);
                if (undoBtn) undoBtn.disabled = false;
                const changed = compactTargetColumnsFromRow(sheet, rowIndex);
                if (changed) {
                  // keep currentSheet in sync and re-validate
                  if (currentSheet === sheet) {
                    syncCurrentSheet();
                    validateSheet(currentSheet);
                  } else {
                    validateSheet(sheet);
                  }
                }
                const tableEl = clearBtn.closest('table');
                if (tableEl) clearColumnHighlight(tableEl);
                clearBtn.blur();
              });
              clearBtn.addEventListener('keydown', ev => {
                if (ev.key === 'Enter' || ev.key === ' ') {
                  ev.preventDefault();
                  clearBtn.click();
                }
              });
              td.appendChild(clearBtn);
            }
            if (comparePartnerFor[header]) {
              td.dataset.compareTarget = comparePartnerFor[header];
            }
            if (input) {
              td.appendChild(input);
            }
            tr.appendChild(td);
          });
          return tr;
        }

        function readCellValue(cell) {
          const input = cell?.querySelector('input, select');
          if (input) return input.value ?? '';
          const text = cell?.querySelector('.cell-text');
          if (text) return text.textContent ?? '';
          return cell?.textContent ?? '';
        }

        function applyDiffForPair(baseCell, compareCell) {
          if (!baseCell) return;
          const baseVal = normalizeValue(readCellValue(baseCell));
          const compareVal = normalizeValue(readCellValue(compareCell));
          const isDifferent = baseVal !== compareVal;
          if (isDifferent) {
            baseCell.classList.add('diff-cell');
            compareCell?.classList.add('diff-cell');
          } else {
            baseCell.classList.remove('diff-cell');
            compareCell?.classList.remove('diff-cell');
          }
        }

        function updateRowDiff(rowEl) {
          if (!rowEl) return;
          const baseCells = rowEl.querySelectorAll('td[data-compare-target]');
          baseCells.forEach(baseCell => {
            const compareHeader = baseCell.dataset.compareTarget;
            const compareIdx = headerIndexMap[compareHeader];
            const compareCell = compareIdx === undefined ? null : rowEl.children[compareIdx];
            applyDiffForPair(baseCell, compareCell);
          });
        }

        baseRows.forEach((row, idx) => {
          const tr = buildRow(row, compRows[idx] || {}, idx);
          tbody.appendChild(tr);
          updateRowDiff(tr);
        });

        table.appendChild(tbody);
        scrollContainer.appendChild(table);
        container.appendChild(scrollContainer);
        enableColumnHighlight(table);

        table.addEventListener('input', event => {
          const rowEl = event.target.closest('tr');
          if (rowEl) updateRowDiff(rowEl);
        });

        table.addEventListener('change', event => {
          const rowEl = event.target.closest('tr');
          if (rowEl) updateRowDiff(rowEl);
        });

        const addBtn = document.createElement('button');
        addBtn.className = 'btn btn-primary';
        addBtn.textContent = 'Add Row';
        addBtn.addEventListener('click', () => {
          if (sheetLock) return;
          pushUndoSnapshot(sheet);
          baseRows.push(createEmptyBaseRow(sheet));
          compRows.push(createEmptyComparisonRow(sheet));
          renderSheet(sheet);
          validateSheet(sheet);
        });
        buttons.appendChild(addBtn);

        const clearAllBtn = document.createElement('button');
        clearAllBtn.className = 'btn btn-outline-danger';
        clearAllBtn.textContent = 'Clear All Rows';
        clearAllBtn.addEventListener('click', () => {
          if (sheetLock) return;
          const tableEl = container.querySelector('table');
          if (!sheetHasTargetValues(sheet)) {
            validateSheet(sheet);
            return;
          }
          pushUndoSnapshot(sheet);
          const stack = getUndoStack(sheet);
          const changed = clearAllRowsValues(sheet, tableEl);
          if (!changed) {
            stack.pop();
            if (undoBtn) undoBtn.disabled = !stack.length;
            validateSheet(sheet);
            return;
          }
          if (undoBtn) undoBtn.disabled = false;
          if (currentSheet === sheet) {
            try { syncCurrentSheet(); } catch (_) {}
          }
          validateSheet(sheet);
        });
        buttons.appendChild(clearAllBtn);

        undoBtn = document.createElement('button');
        undoBtn.className = 'btn btn-outline-secondary';
        undoBtn.textContent = 'Undo';
        undoBtn.disabled = !getUndoStack(sheet).length;
        undoBtn.addEventListener('click', () => {
          if (sheetLock) return;
          const stack = getUndoStack(sheet);
          undoBtn.disabled = !stack.length;
          if (!stack.length) return;
          const snapshot = stack.pop();
          workbook[sheet] = Array.isArray(snapshot.workbook) ? snapshot.workbook : [];
          comparisonData[sheet] = Array.isArray(snapshot.comparison) ? snapshot.comparison : [];
          renderSheet(sheet);
          validateSheet(sheet);
          undoBtn.disabled = !getUndoStack(sheet).length;
        });
        buttons.appendChild(undoBtn);

        const saveBtn = document.createElement('button');
        saveBtn.id = 'export-workbook';
        saveBtn.className = 'btn btn-success';
        saveBtn.textContent = 'Export Workbook';
        saveBtn.addEventListener('click', async () => {
          syncCurrentSheet();
          validateSheet(currentSheet);
          const resp = await fetch('/export', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ data: workbook, locks: sheetLock })
          });
          if (resp.ok) {
            await resp.json().catch(() => {});
            renderErrors();
            alert('Workbook saved to repository');
          } else {
            try {
              const data = await resp.json();
              if (data.errors) {
                errorsBox.classList.remove('d-none');
                errorList.innerHTML = data.errors.map(e => `<li>${e}</li>`).join('');
              } else {
                errorsBox.classList.remove('d-none');
                errorList.innerHTML = '<li>Export failed</li>';
              }
            } catch {
              errorsBox.classList.remove('d-none');
              errorList.innerHTML = '<li>Export failed</li>';
            }
          }
        });
        buttons.appendChild(saveBtn);

        const importInput = document.createElement('input');
        importInput.type = 'file';
        importInput.accept = '.xlsx';
        importInput.style.display = 'none';
        const importBtn = document.createElement('button');
        importBtn.type = 'button';
        importBtn.className = 'btn btn-secondary';
        importBtn.textContent = 'Import Workbook';
        importBtn.addEventListener('click', () => importInput.click());
        importInput.addEventListener('change', async () => {
          if (!importInput.files.length) return;
          const fd = new FormData();
          fd.append('workbook', importInput.files[0]);
          fd.append('stage_only', '1');
          try {
            const resp = await fetch('/import', { method: 'POST', body: fd });
            if (!resp.ok) {
              const message = (await resp.text()) || 'Import failed';
              alert(message);
              return;
            }
            let data = {};
            try {
              data = await resp.json();
            } catch (_) {}
            const dest = window.location.pathname + window.location.search;
            window.location.replace(dest);
          } catch (err) {
            alert('Import failed');
          } finally {
            importInput.value = '';
          }
        });
        buttons.appendChild(importBtn);
        buttons.appendChild(importInput);

        function applyLockState() {
          const locked = sheetLock;
          lockBtn.textContent = locked ? 'ðŸ”’' : 'ðŸ”“';
          lockBtn.className = `btn btn-sm ${locked ? 'btn-lock-protected' : 'btn-lock-unprotected'}`;
          lockBtn.setAttribute('aria-pressed', String(locked));
          lockText.textContent = locked ? 'Workbook Protected' : 'Workbook Unprotected';
          table.querySelectorAll('input, select').forEach(el => {
            el.disabled = locked;
          });
          addBtn.disabled = locked;
          clearAllBtn.disabled = locked || isSheetEmpty(sheet);
          undoBtn.disabled = locked || !getUndoStack(sheet).length;
          table.querySelectorAll('.clear-row-btn').forEach(btn => {
            btn.disabled = locked;
          });
        }

        lockBtn.addEventListener('click', () => {
          sheetLock = !sheetLock;
          applyLockState();
          publishLayoutMetrics();
        });

        applyLockState();
        publishLayoutMetrics?.();
      }

      async function ensureSheetLoaded(sheet) {
        if (workbook[sheet]) return;
        const resp = await fetch(`/sheet/${encodeURIComponent(sheet)}`);
        if (resp.ok) {
          const rows = await resp.json();
          const baseRows = [], compRows = [];
          const hidden = (mappings[sheet] || {}).hidden_cols || [];
          rows.forEach(r => {
            const baseObj = {}, compObj = {};
            renderHeaders[sheet].forEach(h => {
              if (h.endsWith('_COMPARE')) compObj[h] = r[h] || ''; else baseObj[h] = r[h] || '';
            });
            hidden.forEach(h => { baseObj[h] = r[h] || ''; });
            baseRows.push(baseObj); compRows.push(compObj);
          });
          workbook[sheet] = baseRows; comparisonData[sheet] = compRows;
        } else { workbook[sheet] = []; comparisonData[sheet] = []; }
      }

      (async () => {
        if (initialSheet) {
          await ensureSheetLoaded(initialSheet);
          renderSheet(initialSheet);
          validateSheet(initialSheet);
          renderFieldNote(initialSheet);
          publishLayoutMetrics();
        }
      })();

      sheetSelector?.addEventListener('change', () => switchSheet(sheetSelector.value));

      document.addEventListener('input', ev => {
        if (ev.target.closest('#table-wrapper')) { syncCurrentSheet(); validateSheet(currentSheet); }
      });
      document.addEventListener('change', ev => {
        const t = ev.target;
        if (t.classList?.contains('mapped-select')) {
          const sheet = t.dataset.sheet;
          const mapInfo = mappings[sheet]; if (!mapInfo) return;
          const mapping = mapInfo.map; const subCol = mapInfo.sub_col;
          const row = t.closest('tr');
          if (row && subCol) {
            const headerList = Array.from(row.closest('table').querySelectorAll('th')).map(th => th.innerText);
            const subIndex = headerList.indexOf(subCol);
            if (subIndex !== -1) {
              const cell = row.children[subIndex];
              const input = cell.querySelector('input, select');
              if (input) input.value = mapping[t.value] || ''; else cell.textContent = mapping[t.value] || '';
            }
          }
        }
        if (t.closest('#table-wrapper')) { syncCurrentSheet(); validateSheet(currentSheet); }
      });

      async function recomputeAllErrors() {
        if (!window.errorsPerSheet) return;
        const sheets = Object.keys(workbook || {});
        for (const s of sheets) {
          try { validateSheet(s); } catch (_) {}
        }
      }

      function csvEscape(v) {
        const s = String(v == null ? '' : v);
        if (/[",\n]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
        return s;
      }

      function downloadErrorsCsvFallback() {
        const rows = [['Sheet','Message']];
        const eps = window.errorsPerSheet || {};
        for (const [sheet, list] of Object.entries(eps)) {
          (list || []).forEach(msg => rows.push([sheet, msg]));
        }
        const csv = rows.map(r => r.map(csvEscape).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
        a.href = url;
        a.download = `error_report_${ts}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      document.getElementById('export-errors')?.addEventListener('click', async () => {
        try {
          syncCurrentSheet();
          await recomputeAllErrors();

          const resp = await fetch('/export_errors', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data: workbook })
          });

          if (resp.ok) {
            const blob = await resp.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
            const cd = resp.headers.get('Content-Disposition') || '';
            const match = cd.match(/filename="?([^"]+)"?/i);
            a.download = match ? match[1] : `error_report_${ts}.csv`;
            a.href = url;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
          } else {
            downloadErrorsCsvFallback();
          }
        } catch {
          downloadErrorsCsvFallback();
        }
      });

      const confirmImportBtn = document.getElementById('confirm-import-all');
      const cancelImportBtn = document.getElementById('cancel-import');

      function setPendingImportButtonsDisabled(disabled) {
        if (confirmImportBtn) confirmImportBtn.disabled = disabled;
        if (cancelImportBtn) cancelImportBtn.disabled = disabled;
      }

      async function postImportDecision(action) {
        const resp = await fetch('/import/confirm', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action })
        });
        return resp;
      }

      confirmImportBtn?.addEventListener('click', async () => {
        setPendingImportButtonsDisabled(true);
        try {
          const resp = await postImportDecision('apply_all');
          if (resp.ok) {
            location.reload();
          } else {
            const message = await resp.text();
            alert(message || 'Failed to apply import');
            setPendingImportButtonsDisabled(false);
          }
        } catch {
          alert('Failed to apply import');
          setPendingImportButtonsDisabled(false);
        }
      });

      cancelImportBtn?.addEventListener('click', async () => {
        setPendingImportButtonsDisabled(true);
        try {
          const resp = await postImportDecision('cancel');
          if (resp.ok) {
            location.reload();
          } else {
            const message = await resp.text();
            alert(message || 'Failed to cancel import');
            setPendingImportButtonsDisabled(false);
          }
        } catch {
          alert('Failed to cancel import');
          setPendingImportButtonsDisabled(false);
        }
      });

      publishLayoutMetrics();
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initApp);
    } else {
      initApp();
    }
  </script>
</body>
</html>
